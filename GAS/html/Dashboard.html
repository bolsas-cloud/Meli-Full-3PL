<!DOCTYPE html>
<html lang="es">
<head>
 <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Gestión</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root {
      --primary-color: #0092FF; --primary-color-rgb: 0, 146, 255; --secondary-color: #16DB65;
      --warning-color: #FFC107; --danger-color: #FF5757; --text-color: #333333;
      --text-light: #737373; --bg-color: #F5F7FB; --card-bg: #FFFFFF;
      --border-color: #E2E8F0; --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      --radius: 12px;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--bg-color); color: var(--text-color); }
    .dashboard { display: grid; grid-template-columns: 240px 1fr; min-height: 100vh; }
    .sidebar { background-color: var(--card-bg); border-right: 1px solid var(--border-color); padding: 24px 16px; }
    .main { padding: 24px; overflow-x: hidden; }
    .brand { display: flex; align-items: center; gap: 10px; font-size: 20px; font-weight: 600; color: var(--primary-color); margin-bottom: 32px; padding: 0 8px; }
    .menu-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: var(--radius); cursor: pointer; margin-bottom: 4px; color: var(--text-color); text-decoration: none; transition: background-color 0.2s; }
    .menu-item:hover { background-color: rgba(0, 0, 0, 0.05); }
    .menu-item.active { background-color: rgba(var(--primary-color-rgb), 0.1); color: var(--primary-color); font-weight: 500; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color); }
    .page-title { font-size: 24px; font-weight: 600; }
    .header-actions { display: flex; gap: 12px; align-items: center; }
    .last-update { font-size: 14px; color: var(--text-light); }
    .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; margin-bottom: 24px; }
    .card { background-color: var(--card-bg); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); }
    .card-title { font-size: 14px; font-weight: 500; color: var(--text-light); }
    .card-value { font-size: 28px; font-weight: 600; margin: 8px 0; }
    .card-trend { display: flex; align-items: center; gap: 6px; font-size: 14px; }
    .trend-up { color: var(--secondary-color); } .trend-down { color: var(--danger-color); }
    .section { margin-bottom: 24px; }
    .panel { background-color: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 24px; }
    .btn { background-color: var(--primary-color); color: white; border: none; border-radius: var(--radius); padding: 10px 16px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-secondary { background-color: var(--secondary-color); }
    .loading { display: flex; justify-content: center; align-items: center; padding: 24px; color: var(--text-light); }
    .spinner { margin-right: 12px; animation: spin 1s linear infinite; }
    .google-visualization-table-th, .google-visualization-table-td { border-bottom: 1px solid var(--border-color) !important; padding: 12px 16px !important; }
    .main-section { display: none; }
    .filtro-container { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .btn-filtro { padding: 6px 12px; font-size: 14px; border: 1px solid var(--border-color); background-color: transparent; color: var(--text-color); border-radius: var(--radius); cursor: pointer; transition: all 0.2s; }
    .btn-filtro:hover { background-color: rgba(var(--primary-color-rgb), 0.1); }
    .btn-filtro.active { background-color: var(--primary-color); color: white; }
    .card.card-status-preparacion { border-left: 5px solid var(--warning-color); }
    .card.card-status-despachado { border-left: 5px solid var(--primary-color); }
    .card.card-status-recibido { border-left: 5px solid var(--secondary-color); }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
/* --- Estilos para Modo Preparación --- */
.foco-escaneo-pendiente {
  background-color: #f8f9fa;
  border: 2px dashed var(--border-color);
  color: var(--text-light);
}
.foco-escaneo-activo {
  background-color: rgba(var(--primary-color-rgb), 0.1);
  border: 2px solid var(--primary-color);
  color: var(--primary-color);
}
#foco-escaneo {
  padding: 24px;
  text-align: center;
  border-radius: var(--radius);
  margin-bottom: 16px;
  transition: all 0.3s ease;
}
.foco-titulo {
  font-size: 24px;
  font-weight: 600;
}
.info-secundaria-foco {
  font-size: 14px;
  margin: 4px 0 12px 0;
}
.foco-contador {
  font-size: 36px;
  font-weight: bold;
}
.input-escaner {
  width: 100%;
  padding: 12px;
  font-size: 18px;
  text-align: center;
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}
.tabla-preparacion {
  width: 100%;
  border-collapse: collapse;
}
.tabla-preparacion th, .tabla-preparacion td {
  padding: 12px;
  border-bottom: 1px solid var(--border-color);
  text-align: left;
}
.tabla-preparacion td {
  font-size: 14px;
}
.tabla-preparacion .inventory-id, .tabla-preparacion .cant-a-enviar, .tabla-preparacion .cant-escaneada {
  font-family: monospace;
  font-size: 15px;
  text-align: center;
}
.tag-estado {
  padding: 4px 8px;
  border-radius: 16px;
  font-size: 12px;
  font-weight: 500;
  color: white;
}
.tag-pendiente { background-color: #6c757d; }
.tag-progreso { background-color: var(--warning-color); color: #333; }
.tag-completado { background-color: var(--secondary-color); }

.estado-en-progreso td { background-color: #FFFBE6; }
.estado-completado td { background-color: #F6FFED; text-decoration: line-through; color: var(--text-light); }

/* --- Estilos para Sub-Encabezado de Preparación --- */
.sub-header-preparacion {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding: 12px;
  background-color: var(--card-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}

/* --- Estilos para Indicador de Estado --- */
.status-indicator {
  display: inline-block;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  margin-right: 8px;
  vertical-align: middle;
}
.status-active { background-color: var(--secondary-color); }
.status-paused { background-color: var(--warning-color); }
.status-closed { background-color: var(--danger-color); }
.status-under_review { background-color: #6c757d; }
.status-inactive { background-color: #6c757d; }
.status-desconocido { background-color: var(--border-color); }

/* --- Estilos para Controles de Escaneo Manual (Versión Corregida) --- */
.escaner-container {
  display: flex;
  justify-content: center; /* Centra todo el grupo */
  align-items: center;
  gap: 12px; /* Aumentamos un poco el espacio */
  margin-top: 16px;
}
.input-escaner {
  width: 100%; /* Hacemos que ocupe el espacio disponible */
  max-width: 450px; /* Pero con un ancho máximo para que no sea gigante */
  height: 55px; /* Altura fija */
  padding: 12px;
  font-size: 20px; /* Letra más grande */
  text-align: center;
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}
.btn-ajuste {
  font-size: 28px; /* Símbolos más grandes */
  font-weight: bold;
  width: 55px;   /* Botones más grandes */
  height: 55px;  /* Misma altura que el input */
  border-radius: 50%;
  border: 1px solid var(--border-color);
  background-color: #f8f9fa;
  cursor: pointer;
  flex-shrink: 0; /* Evita que los botones se encojan */
}
.btn-ajuste:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

/* --- Estilos para Tabla de Stock --- */
.stock-editable {
  width: 80px;
  text-align: right;
  padding: 6px;
  border: 1px solid #ccc;
  border-radius: var(--radius);
  font-size: 15px;
}
.stock-editable:read-only {
  background-color: #f8f9fa;
  border-color: #eee;
  color: var(--text-light);
}
.flex-toggle {
  width: 20px;
  height: 20px;
  cursor: pointer;
}
.flex-toggle:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* --- Estilo para filas modificadas --- */
.fila-modificada td {
  background-color: var(--warning-color) !important;
  background-color: rgba(255, 193, 7, 0.2) !important; /* Amarillo suave */
  transition: background-color 0.3s ease;
}

/* --- Estilos para Toggle Switch --- */
.switch {
  position: relative;
  display: inline-block;
  width: 50px; /* Ancho del switch */
  height: 24px; /* Alto del switch */
}
.switch input { 
  opacity: 0;
  width: 0;
  height: 0;
}
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 24px;
}
.slider:before {
  position: absolute;
  content: "";
  height: 18px; /* Diámetro del círculo */
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}
input:checked + .slider {
  background-color: var(--secondary-color); /* Color verde cuando está activo */
}
input:checked + .slider:before {
  transform: translateX(26px); /* Desplazamiento */
}
input:disabled + .slider {
  cursor: not-allowed;
  opacity: 0.5;
}

/* --- Estilos para Zona de Drop --- */
#drop-zone.drag-over {
  background-color: rgba(var(--secondary-color-rgb), 0.1); /* Asumiendo que tienes --secondary-color-rgb */
  /* Si no, usamos un verde suave: */
  background-color: #e8f5e9; 
  border-color: var(--secondary-color);
}

  </style>
</head>
<body>
  <div class="dashboard">
    <aside class="sidebar">
      <div class="brand"><i class="fas fa-store"></i><span>Gestor ML</span></div>
      <nav class="menu">
        <a href="#" id="menu-dashboard" class="menu-item"><i class="fas fa-chart-line"></i><span>Dashboard</span></a>
        <a href="#" id="menu-gestion-full" class="menu-item"><i class="fas fa-calculator"></i><span>Calculadora Envíos</span></a>
        <a href="#" id="menu-envios-creados" class="menu-item"><i class="fas fa-truck-loading"></i><span>Envíos Creados</span></a>
        <a href="#" id="menu-precios" class="menu-item"><i class="fas fa-dollar-sign"></i><span>Gestión de Precios</span></a>
        <a href="#" id="menu-stock" class="menu-item"><i class="fas fa-boxes"></i><span>Seguimiento de Stock</span></a>
        <a href="#" id="menu-gestion-3pl" class="menu-item"><i class="fas fa-warehouse"></i><span>Gestión Depósito 3PL</span></a>
      </nav>
    </aside>

    <main class="main">
      <header class="header">
        <h1 class="page-title" id="page-title">Dashboard</h1>
        <div class="header-actions">
          <span class="last-update" id="last-update"></span>
          <button class="btn" id="btn-forzar-actualizacion-completa" style="background-color: var(--warning-color); color: #333;"><i class="fas fa-sync-alt"></i><span> Forzar Actualización</span></button>
        </div>
      </header>

      <section id="seccion-dashboard" class="main-section">
        <div class="panel" style="margin-bottom: 24px;">
          <div style="display: flex; flex-wrap: wrap; gap: 16px; align-items: center;">
            <div style="display: flex; gap: 8px;">
              <button class="btn-filtro" data-periodo="hoy">Hoy</button> <button class="btn-filtro" data-periodo="ayer">Ayer</button> <button class="btn-filtro" data-periodo="semana">Últ. 7 días</button>
              <button class="btn-filtro active" data-periodo="mes_actual">Mes Actual</button> <button class="btn-filtro" data-periodo="mes_anterior">Mes Anterior</button>
            </div>
            <div style="display: flex; gap: 8px; align-items: center; margin-left: auto;">
              <input type="date" id="fecha-inicio" style="padding: 7px; border: 1px solid var(--border-color);"><input type="date" id="fecha-fin" style="padding: 7px; border: 1px solid var(--border-color);">
              <button class="btn" id="btn-aplicar-filtro">Aplicar</button>
            </div>
          </div>
        </div>
        <div class="card-grid">
            <div class="card">
              <div class="card-title">Ventas Netas</div>
                <div class="card-value" id="kpi-ventas">$0</div>
                <div class="card-trend" id="kpi-ventas-comp"></div>
            </div>
            <div class="card">
              <div class="card-title">Órdenes</div>
              <div class="card-value" id="kpi-ordenes">0</div>
              <div class="card-trend" id="kpi-ordenes-comp"></div>
            </div>
            <div class="card">
              <div class="card-title">Inversión Publicidad</div>
              <div class="card-value" id="kpi-publicidad">$0</div>
              <div class="card-trend" id="kpi-publicidad-comp"></div>
            </div>
            <div class="card">
              <div class="card-title">ACOS (Publicidad)</div>
              <div class="card-value" id="kpi-acos">0%</div>
              <div class="card-trend" id="kpi-acos-comp"></div>
            </div>
        </div>
        <div class="panel"><div id="line_chart_div" style="width: 100%; height: 400px;"></div></div>
      </section>

      <section id="seccion-gestion-full" class="main-section">
        <div class="panel">
          <div class="card-grid" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); margin-bottom: 24px;">
            <div class="card">
              <label class="card-title">Tiempo Tránsito (Tt)</label>
              <input type="number" id="tiempoTransito" value="3" style="width: 100%; font-size: 24px; border: none; font-weight: 600;">
            </div>
            <div class="card">
              <label class="card-title">Frecuencia Envío (Fe)</label>
              <input type="number" id="frecuenciaEnvio" value="7" style="width: 100%; font-size: 24px; border: none; font-weight: 600;">
            </div>
            <div class="card">
              <label class="card-title">Nivel Servicio (Z)</label>
              <select id="nivelServicio" style="width: 100%; font-size: 24px; border: none; font-weight: 600;">
                <option value="1.65" selected>95%</option><option value="1.28">90%</option><option value="2.05">98%</option><option value="2.33">99%</option>
              </select>
            </div>
          </div>
          <div style="text-align: center; margin-bottom: 24px;">
            <button class="btn btn-secondary" id="btn-calcular-envios"><i class="fas fa-calculator"></i><span>Calcular Sugerencias</span></button>
          </div>


        <div class="filtro-container" id="filtro-container" style="display: none; align-items: center; flex-wrap: wrap; gap: 16px;">
          <span style="font-weight: 500;">Riesgo:</span>
          <button class="btn-filtro active" data-filtro="todos">Todos</button>
          <button class="btn-filtro" data-filtro="CRÍTICO">Crítico</button>
          <button class="btn-filtro" data-filtro="RIESGO">Riesgo</button>
          <button class="btn-filtro" data-filtro="Normal">Normal</button>
          
          <div style="border-left: 1px solid var(--border-color); height: 24px; margin: 0 8px;"></div>
          
          <input type="search" id="input-buscar-sugerencia" placeholder="Buscar por SKU o Título..." style="padding: 6px 12px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 14px; min-width: 250px;">
          
          <div style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="seleccionar-todo-sugerencias" style="width: 18px; height: 18px; cursor:pointer;">
            <label for="seleccionar-todo-sugerencias" style="cursor:pointer; font-weight: 500;">Seleccionar Visibles</label>
          </div>
        </div>


          <div id="sugerencias-tabla-div" style="margin-top: 16px;">
            <div class="loading"><i class="fas fa-info-circle"></i><span style="margin-left: 8px;">Presiona "Calcular" para generar sugerencias.</span></div>
          </div>
          <div id="registro-container" style="text-align: center; margin-top: 24px; display:none; gap: 10px;">
            <button class="btn" id="btn-registrar-envio"><i class="fas fa-save"></i><span>Registrar Envío</span></button>
            <button class="btn" id="btn-descargar-borrador" style="background-color: #6c757d;"><i class="fas fa-file-pdf"></i> Descargar Borrador</button>
          </div>
        </div>
      </section>

      <section id="seccion-gestion-envios" class="main-section">
        <div class="panel" id="panel-envios-creados"></div>
      </section>

      <section id="seccion-gestion-precios" class="main-section">
        <div class="panel">

          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 16px;">
            <input type="search" id="input-buscar-producto" placeholder="Buscar por SKU o Título..." style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 14px; min-width: 300px;">
            <div class="filtros-estado-precios">
              <span style="font-weight: 500; margin-right: 8px;">Estado:</span>
              <button class="btn-filtro-estado active" data-filtro="todos">Todos</button>
              <button class="btn-filtro-estado" data-filtro="active">Activas</button>
              <button class="btn-filtro-estado" data-filtro="paused">Pausadas</button>
            </div>
            <div style="display: flex; gap: 8px; align-items: center; border: 1px solid var(--border-color); padding: 4px 8px; border-radius: 8px;">
              <span>Modificar seleccionados:</span>
              <select id="select-tipo-modificacion" style="padding: 8px; border: none; background: transparent;"><option value="porcentaje">%</option><option value="fijo">$</option></select>
              <input type="number" id="input-valor-modificacion" placeholder="Valor" style="width: 80px; padding: 8px; border: 1px solid var(--border-color);">
              <button id="btn-previsualizar-precios" class="btn">Previsualizar</button>
            </div>
            
            <div style="display: flex; gap: 8px;">
              <button id="btn-resetear-precios" class="btn" style="background-color: #6c757d;" title="Deshacer cambios no guardados">
                <i class="fas fa-undo"></i> Resetear
              </button>
              <button id="btn-guardar-precios" class="btn btn-secondary"><i class="fas fa-save"></i> Guardar Cambios en ML</button>
              <button id="btn-forzar-recalculo" class="btn" style="background-color: var(--warning-color); color: #333;" title="Recalcular todos los costos desde la API">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>

          </div>

          <div id="tabla-precios-div" class="loading">Cargando...</div>
        </div>
      </section>
      <section id="seccion-modo-preparacion" class="main-section">
        
        <div class="sub-header-preparacion">
          <h4 id="titulo-preparacion-envio" style="margin: 0; font-size: 18px;"></h4>
          <div class="botones-accion-preparacion">
            <button class="btn" id="btn-cancelar-preparacion" style="background-color: #6c757d;">
              <i class="fas fa-times"></i> Cancelar
            </button>
            <button class="btn btn-secondary" id="btn-finalizar-preparacion">
              <i class="fas fa-check-circle"></i> Finalizar Preparación
            </button>
          </div>
        </div>

        <div class="panel">
          <div id="foco-escaneo" class="foco-escaneo-pendiente">
            <div id="foco-titulo" class="foco-titulo">Esperando primer escaneo...</div>
            <div class="info-secundaria-foco">
              <span id="foco-sku">SKU: -</span> | <span id="foco-inventory-id">Inventory ID: -</span>
            </div>
            <div id="foco-contador" class="foco-contador"></div>
          </div>
          
          <div class="escaner-container">
            <button id="btn-restar-cantidad" class="btn-ajuste" disabled>-</button>
            <input type="text" id="input-escaner" class="input-escaner" placeholder="[ Apunta el escáner aquí o ingresa un ID ]" autocomplete="off">
            <button id="btn-sumar-cantidad" class="btn-ajuste" disabled>+</button>
          </div>
          
          <div id="lista-productos-preparacion" style="margin-top: 24px;">
            <table id="tabla-preparacion" class="tabla-preparacion">
              <thead>
                <tr>
                  <th>SKU / Título</th>
                  <th>Inventory ID</th>
                  <th>A Enviar</th>
                  <th>Escaneados</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody>
                </tbody>
            </table>
          </div>
        </div>
      </section>
      <section id="seccion-seguimiento-stock" class="main-section">
        <div class="panel">
          <div style="display: flex; gap: 16px; align-items: center; margin-bottom: 24px; flex-wrap: wrap;">
            <input type="search" id="input-buscar-stock" placeholder="Filtrar por SKU o Título..." style="flex-grow: 1; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 14px; min-width: 300px;">
            
            <button class="btn" id="btn-previsualizar-stock" style="background-color: #6c757d;">
              <i class="fas fa-eye"></i> Previsualizar Cambios
            </button>
            <button class="btn btn-secondary" id="btn-guardar-cambios-stock">
              <i class="fas fa-save"></i> Guardar Cambios
            </button>
          </div>

          <div id="tabla-stock-div">
            <div class="loading">
              <i class="fas fa-info-circle"></i><span style="margin-left: 8px;">Cargando datos de stock...</span>
            </div>
          </div>
        </div>
      </section>
     <section id="seccion-gestion-3pl" class="main-section">
  
      <div class="panel" style="margin-bottom: 24px;">
        <h4><i class="fas fa-sync-alt"></i> 1. Reconciliación de Stock</h4>
        <p style="color: var(--text-light); font-size: 14px;">Carga el reporte de stock de tu depósito externo para compararlo con Mercado Libre.</p>

        <div id="drop-zone" style="border: 2px dashed var(--border-color); border-radius: var(--radius); padding: 40px; text-align: center; margin-top: 20px; transition: background-color 0.3s ease;">
          <i class="fas fa-file-excel" style="font-size: 48px; color: var(--secondary-color);"></i>
          <p style="font-size: 16px; font-weight: 500; margin-top: 16px;">Arrastra y suelta tu archivo Excel (.xls o .xlsx) aquí</p>
          <p style="color: var(--text-light); margin-top: 8px;">o</p>
          <input type="file" id="file-input-excel" accept=".xlsx, .xls" style="display: none;">
          <button class="btn" onclick="document.getElementById('file-input-excel').click();" style="background-color: var(--primary-color);">Seleccionar Archivo</button>
        </div>

        <div id="panel-resultados-reconciliacion" style="display: none; margin-top: 24px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px;">
            <div>
              <h5 style="margin: 0;">Resultados de la Comparación</h5>
              <span id="info-reconciliacion" style="font-size: 14px; color: var(--text-light);"></span>
            </div>
            <div>
              <button class="btn" id="btn-resetear-3pl" style="background-color: #6c757d; margin-right: 10px;">
                <i class="fas fa-redo"></i> Cargar Otro
              </button>
              <button class="btn" id="btn-ajustar-stock-ml" style="background-color: var(--danger-color);">
                <i class="fas fa-exclamation-triangle"></i> Ajustar Stock en ML
              </button>
            </div>
          </div>
          <div id="tabla-reconciliacion-div"></div>
        </div>
      </div>

      <div class="panel" id="panel-inicio-3pl">
        <h4><i class="fas fa-box-open"></i> 2. Preparar Envío a Depósito Externo</h4>
        <p style="color: var(--text-light); font-size: 14px;">Usa el escáner para armar una caja y generar el remito para tu 3PL.</p>
        <div style="text-align: center; margin-top: 20px;">
          <button class="btn btn-secondary" id="btn-iniciar-preparacion-3pl">
            <i class="fas fa-barcode"></i> Iniciar Escaneo de Envío
          </button>
        </div>
      </div>

      <div id="panel-preparacion-3pl" class="panel" style="display: none; margin-top: 24px; border-top: 5px solid var(--primary-color);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3><i class="fas fa-dolly"></i> Nuevo Envío a Depósito Externo</h3>
          <button class="btn" id="btn-guardar-salir-3pl" style="background-color: var(--primary-color); margin-right: 10px;">
            <i class="fas fa-save"></i> Guardar y Salir
          </button>
          <button class="btn" id="btn-cancelar-3pl" style="background-color: #6c757d;">
            <i class="fas fa-times"></i> Cancelar
          </button>
        </div>

        <div style="background-color: var(--bg-color); padding: 20px; border-radius: var(--radius); text-align: center; margin-bottom: 20px;">
          <div id="foco-3pl-titulo" style="font-size: 22px; font-weight: 600; margin-bottom: 10px;">Listo para escanear</div>
          <div id="foco-3pl-sku" style="font-size: 16px; color: var(--text-light); margin-bottom: 20px;">Escanea un producto para agregarlo</div>
          
          <div class="escaner-container">
            <button id="btn-restar-3pl" class="btn-ajuste" disabled>-</button>
            <input type="text" id="input-escaner-3pl" class="input-escaner" placeholder="[ Escanea SKU o Inventory ID aquí ]" autocomplete="off">
            <button id="btn-sumar-3pl" class="btn-ajuste" disabled>+</button>
          </div>
        </div>

        <div style="max-height: 400px; overflow-y: auto;">
          <table id="tabla-productos-3pl" style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background-color: #f8f9fa; text-align: left;">
                <th style="padding: 12px; border-bottom: 2px solid var(--border-color);">Producto</th>
                <th style="padding: 12px; border-bottom: 2px solid var(--border-color); text-align: center;">Cantidad</th>
                <th style="padding: 12px; border-bottom: 2px solid var(--border-color);"></th>
              </tr>
            </thead>
            <tbody id="tbody-productos-3pl">
              </tbody>
          </table>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border-color);">
          <div style="font-size: 18px;">
            Total Unidades: <strong id="total-unidades-3pl">0</strong> | Total Productos: <strong id="total-skus-3pl">0</strong>
          </div>
          <button class="btn btn-secondary" id="btn-finalizar-3pl" disabled>
            <i class="fas fa-check"></i> Continuar al Despacho
          </button>
        </div>
      </div>

    </section>
      
   </main>
  </div>

  <div id="modal-fecha-colecta" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div style="background-color:white; padding:24px; border-radius:12px; width:350px;">
      <h3>Confirmar Fecha de Colecta</h3><p>Ingresa la fecha de colecta asignada por Mercado Libre.</p>
      <input type="date" id="input-fecha-colecta" style="width:100%; padding:10px; margin:16px 0; border: 1px solid #ccc; border-radius: 4px; font-size: 16px;">
      <div style="text-align:right;"><button id="btn-cancelar-colecta" class="btn" style="background-color:#6c757d; margin-right:8px;">Cancelar</button><button id="btn-confirmar-colecta" class="btn">Confirmar</button></div>
    </div>
  </div>
  <div id="modal-edicion-envio" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div style="background-color:white; padding:24px; border-radius:12px; width:90%; max-width:600px;">
      <h3 id="modal-titulo-envio">Editando Envío</h3><div id="modal-tabla-productos" style="max-height: 300px; overflow-y: auto; margin:16px 0;"></div>
      <div style="display:flex; gap:10px; margin:16px 0; border-top: 1px solid #eee; padding-top: 16px;">
          <input type="text" id="input-nuevo-sku" list="lista-productos" placeholder="Buscar SKU o Título para agregar..." style="padding: 8px; border: 1px solid #ccc; flex-grow:1;"><datalist id="lista-productos"></datalist>
          <input type="number" id="input-nueva-cantidad" placeholder="Cant." min="1" style="padding: 8px; border: 1px solid #ccc; width: 70px;"><button id="btn-agregar-producto" class="btn btn-secondary">Agregar</button>
      </div>
      <div style="text-align:right; margin-top: 24px;"><button id="btn-cancelar-edicion" class="btn" style="background-color:#6c757d; margin-right:8px;">Cancelar</button><button id="btn-guardar-cambios-envio" class="btn">Guardar Cambios</button></div>
    </div>
  </div>
  <div id="modal-generico" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); z-index:2000; justify-content:center; align-items:center;">
    <div style="background-color:var(--card-bg); color:var(--text-color); padding:24px; border-radius:12px; width:90%; max-width:450px; text-align:center;">
      <h3 id="modal-titulo">Título</h3><p id="modal-mensaje" style="margin:16px 0;"></p><div id="modal-botones" style="display:flex; justify-content:flex-end; gap:10px;"></div>
    </div>
  </div>

  <div id="modal-finalizar-3pl" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
  <div style="background-color:var(--card-bg); padding:24px; border-radius:var(--radius); width:90%; max-width:400px;">
    <h3>Finalizar Envío a 3PL</h3>
    <p style="color: var(--text-light); font-size: 14px; margin-bottom: 16px;">Completa los datos para el remito y el registro.</p>
    
    <label style="font-weight: 500; display: block; margin-bottom: 4px;">Empresa de Transporte:</label>
    <input type="text" id="input-3pl-transporte" style="width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid var(--border-color); border-radius: var(--radius);">
    
    <div style="display: flex; gap: 12px; margin-bottom: 12px;">
      <div style="flex: 1;">
        <label style="font-weight: 500; display: block; margin-bottom: 4px;">Cant. Bultos:</label>
        <input type="number" id="input-3pl-bultos" min="1" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius);">
      </div>
      <div style="flex: 1;">
        <label style="font-weight: 500; display: block; margin-bottom: 4px;">Valor Declarado ($):</label>
        <input type="number" id="input-3pl-valor" min="0" step="0.01" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius);">
      </div>
    </div>

    <label style="font-weight: 500; display: block; margin-bottom: 4px;">Notas (Opcional):</label>
    <textarea id="input-3pl-notas" rows="3" style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: var(--radius); resize: none;"></textarea>

    <div style="text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
      <button id="btn-cancelar-finalizar-3pl" class="btn" style="background-color: #6c757d;">Volver</button>
      <button id="btn-confirmar-finalizar-3pl" class="btn btn-secondary">
        <i class="fas fa-save"></i> Registrar Envío
      </button>
    </div>
  </div>
</div>




<script>
google.charts.load('current', {'packages':['corechart', 'table']});
  google.charts.setOnLoadCallback(initDashboard);

// --- Variables Globales (Limpiadas) ---
  let cacheEnvios = [], cachePrecios = [], fechaColectaCalculada = '';
  let envioEnPreparacionId = null;
  let colaDeGuardado = [];      
  let guardadoEnCurso = false;   
  let limpiezaTimeoutId = null;
  let escanerBloqueado = false;


// --- Variables para Preparación 3PL ---
let productos3PL = [];      // La lista de lo que hay en la caja
let escaneo3PLActivo = false;
let mapaMaestro3PL = {};    // El "diccionario" para encontrar productos rápido
let ultimoSkuFoco3PL = null; // Para saber a qué producto afectan los botones +/-


  // --- INICIALIZACIÓN Y NAVEGACIÓN ---
  function initDashboard() {
    setupEventListeners();
    handleMenuClick('seccion-dashboard', document.getElementById('menu-dashboard')); 
  }

// ▼▼▼ REEMPLAZA esta función ▼▼▼
function handleMenuClick(targetSectionId, clickedMenuItem) {
  document.querySelectorAll('.main-section').forEach(section => section.style.display = 'none');
  const target = document.getElementById(targetSectionId);
  if (target) target.style.display = 'block';
  
  const pageTitle = document.getElementById('page-title');
  document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
  if (clickedMenuItem) clickedMenuItem.classList.add('active');

  if (targetSectionId === 'seccion-dashboard') {
    pageTitle.textContent = 'Dashboard de Ventas';
    if(document.getElementById('kpi-ventas').textContent === '$0') {
      document.querySelector('.btn-filtro[data-periodo="mes_actual"]').click();
    }
  } else if (targetSectionId === 'seccion-gestion-full') {
    pageTitle.textContent = 'Calculadora de Envíos a Full';
  } else if (targetSectionId === 'seccion-gestion-envios') {
    pageTitle.textContent = 'Envíos Creados';
    cargarVistaDeEnvios();
  } else if (targetSectionId === 'seccion-gestion-precios') {
    pageTitle.textContent = 'Gestión de Precios y Rentabilidad';
    cargarVistaDePrecios();
  } else if (targetSectionId === 'seccion-modo-preparacion') {
    pageTitle.textContent = 'Modo Preparación de Envío';
  } else if (targetSectionId === 'seccion-seguimiento-stock') { // <-- SECCIÓN EXISTENTE (corregida)
    pageTitle.textContent = 'Seguimiento de Stock (Full y Depósito)';
    cargarVistaStock();
  } else if (targetSectionId === 'seccion-gestion-3pl') { // <-- SECCIÓN NUEVA
    pageTitle.textContent = 'Gestión Depósito Externo (3PL)';
    cargarVistaGestion3PL();
  }
}



// ▼▼▼ REEMPLAZA esta función ▼▼▼
function handleGuardarStockClick() {
  if (!window.datosStock) { mostrarModal('Error', 'No hay datos cargados.'); return; }

  const cambiosParaEnviar = [];
  const filasTabla = document.querySelectorAll("#tabla-stock-div tbody tr");

  filasTabla.forEach(fila => {
    const inputStock = fila.querySelector('.stock-editable');
    const checkFlex = fila.querySelector('.flex-toggle');
    const checkEstado = fila.querySelector('.estado-toggle');
    if (!inputStock || !checkFlex || !checkEstado) return;

    const itemId = inputStock.dataset.itemId || checkFlex.dataset.itemId;
    if (!itemId) return;

    const productoOriginal = window.datosStock.find(p => p.itemId === itemId);
    if (!productoOriginal) return;

    const stockActual = parseInt(inputStock.value);
    const flexActual = checkFlex.checked;
    const estadoActual = checkEstado.checked ? 'active' : 'paused';

    const stockCambiado = (productoOriginal.stockDeposito !== stockActual);
    const flexCambiado = (productoOriginal.tieneFlex !== flexActual);
    const estadoCambiado = (productoOriginal.estado !== estadoActual);

    if (stockCambiado || flexCambiado || estadoCambiado) {
      cambiosParaEnviar.push({
        itemId: itemId,
        userProductId: productoOriginal.userProductId, // Necesitamos enviar esto
        sku: productoOriginal.sku,
        stockCambiado: stockCambiado,
        nuevoStock: stockActual,
        flexCambiado: flexCambiado,
        nuevoFlex: flexActual,
        estadoCambiado: estadoCambiado,
        nuevoEstado: estadoActual
      });
    }
  });

  if (cambiosParaEnviar.length === 0) {
    mostrarModal('Información', 'No se detectaron cambios para guardar.');
    return;
  }

  mostrarModal('Confirmar Cambios', `Estás a punto de guardar ${cambiosParaEnviar.length} cambios en Mercado Libre. ¿Continuar?`, [
    { texto: 'Cancelar' },
    {
      texto: 'Sí, Guardar Cambios',
      clase: 'btn btn-secondary',
      callback: () => {
        const btn = document.getElementById('btn-guardar-cambios-stock');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Guardando...';

        google.script.run
          .withSuccessHandler(resultado => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
            
            let mensaje = `${resultado.exitosos.length} cambios se guardaron con éxito.`;
            if (resultado.fallidos.length > 0) {
              mensaje += `\n${resultado.fallidos.length} fallaron.`;
            }
            
            mostrarModal('Proceso Finalizado', mensaje, [{
              texto: 'Aceptar y Recargar',
              clase: 'btn',
              callback: () => cargarVistaStock()
            }]);
          })
          .withFailureHandler(err => {
            showError(err);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
          })
          .actualizarStockYFlexEnLote(cambiosParaEnviar);
      }
    }
  ]);
}





// ▼▼▼ REEMPLAZA esta función ▼▼▼

/**
 * Conecta TODOS los event listeners de la aplicación
 * VERSIÓN FINAL: Conecta el botón de "Ajustar Stock 3PL".
 */
function setupEventListeners() {
    // Menú
    document.getElementById('menu-dashboard').addEventListener('click', e => { e.preventDefault(); handleMenuClick('seccion-dashboard', e.currentTarget); });
    document.getElementById('menu-gestion-full').addEventListener('click', e => { e.preventDefault(); handleMenuClick('seccion-gestion-full', e.currentTarget); });
    document.getElementById('menu-envios-creados').addEventListener('click', e => { e.preventDefault(); handleMenuClick('seccion-gestion-envios', e.currentTarget); });
    document.getElementById('menu-precios').addEventListener('click', e => { e.preventDefault(); handleMenuClick('seccion-gestion-precios', e.currentTarget); });
    document.getElementById('menu-stock').addEventListener('click', e => { e.preventDefault(); handleMenuClick('seccion-seguimiento-stock', e.currentTarget); });
    document.getElementById('menu-gestion-3pl').addEventListener('click', e => { e.preventDefault(); handleMenuClick('seccion-gestion-3pl', e.currentTarget); });

    // Dashboard
    document.querySelectorAll('.btn-filtro').forEach(btn => btn.addEventListener('click', handleFiltroClick));
    document.getElementById('btn-aplicar-filtro').addEventListener('click', actualizarDashboard);
    document.getElementById('btn-forzar-actualizacion-completa').addEventListener('click', handleForzarActualizacion);
    
    // Calculadora Envíos
    document.getElementById('btn-calcular-envios').addEventListener('click', handleCalcularClick);
    document.getElementById('btn-registrar-envio').addEventListener('click', handleRegistrarEnvioClick);
    document.getElementById('btn-descargar-borrador').addEventListener('click', handleDescargarBorradorClick);
    
    // Envíos Creados
    document.getElementById('panel-envios-creados').addEventListener('click', handleAccionDeEnvioClick);
    
    // Gestión Precios
    document.getElementById('input-buscar-producto').addEventListener('input', filtrarTablaPrecios);
    document.querySelectorAll('.btn-filtro-estado').forEach(btn => { /* ... */ });
    document.getElementById('btn-previsualizar-precios').addEventListener('click', handleAplicarPreciosClick);
    document.getElementById('btn-guardar-precios').addEventListener('click', handleGuardarPreciosClick);
    document.getElementById('btn-forzar-recalculo').addEventListener('click', handleForzarRecalculoClick);
    document.getElementById('btn-resetear-precios').addEventListener('click', handleResetearPrecios);

    // Seguimiento Stock
    document.getElementById('input-buscar-stock').addEventListener('input', filtrarTablaStock);
    document.getElementById('btn-previsualizar-stock').addEventListener('click', handlePrevisualizarStock);
    document.getElementById('btn-guardar-cambios-stock').addEventListener('click', handleGuardarStockClick);
    
    // --- LISTENERS PARA GESTIÓN 3PL (CORREGIDOS) ---
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input-excel');

    // Listeners para "Arrastrar y Soltar"
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('drag-over'); });
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      if (e.dataTransfer.files[0]) { procesarArchivoExcel(e.dataTransfer.files[0]); }
    });
    // Listener para el botón "Seleccionar Archivo"
    fileInput.addEventListener('change', (e) => {
      if (e.target.files[0]) { procesarArchivoExcel(e.target.files[0]); }
    });
    
    // Listener para el botón de "Cargar Otro"
    document.getElementById('btn-resetear-3pl').addEventListener('click', resetearVista3PL);
    
    // --- CAMBIO CLAVE: Conectamos el botón de Ajustar Stock ---
    document.getElementById('btn-ajustar-stock-ml').addEventListener('click', handleAjustarStockClick);
    
    // (Busca el listener de 'btn-iniciar-preparacion-3pl' y reemplázalo)
    document.getElementById('btn-iniciar-preparacion-3pl').addEventListener('click', iniciarPreparacion3PL);

    // (Añade el listener para el botón de cancelar que ya pusimos en el HTML)
    document.getElementById('btn-cancelar-3pl').addEventListener('click', cancelarPreparacion3PL);

    // --- AÑADE ESTO A setupEventListeners o similar ---
    document.getElementById('btn-finalizar-3pl').addEventListener('click', () => {
      // Abrimos el modal
      document.getElementById('modal-finalizar-3pl').style.display = 'flex';
      // Pre-llenamos o limpiamos campos si es necesario
      document.getElementById('input-3pl-transporte').value = '';
      document.getElementById('input-3pl-bultos').value = '1';
      document.getElementById('input-3pl-valor').value = '';
      document.getElementById('input-3pl-notas').value = '';
    });

    document.getElementById('btn-cancelar-finalizar-3pl').addEventListener('click', () => {
      document.getElementById('modal-finalizar-3pl').style.display = 'none';
    });

    document.getElementById('btn-confirmar-finalizar-3pl').addEventListener('click', handleRegistrarEnvio3PL);


    document.getElementById('btn-guardar-salir-3pl').addEventListener('click', () => {
    if (productos3PL.length === 0) {
      // Si no hay nada, es igual a cancelar
      ejecutarCancelacion3PL();
      return;
    }
    
    // Mostramos feedback visual inmediato
    const btn = document.getElementById('btn-guardar-salir-3pl');
    const htmlOriginal = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Guardando...';

    google.script.run
      .withSuccessHandler(msg => {
        mostrarModal('Guardado', 'Tu progreso ha sido guardado. Podrás retomarlo cuando vuelvas.', [], 'info', 2000);
        ejecutarCancelacion3PL(); // Salimos de la pantalla
        btn.disabled = false;
        btn.innerHTML = htmlOriginal;
      })
      .withFailureHandler(err => {
        showError(err);
        btn.disabled = false;
        btn.innerHTML = htmlOriginal;
      })
      .guardarBorrador3PL(productos3PL);
  });
    
}



/**
 * Maneja los clics en los botones de filtro de fecha.
 * VERSIÓN CORREGIDA: Construye las fechas de forma segura para evitar
 * problemas de zona horaria.
 */
function handleFiltroClick() {
  document.querySelectorAll('.btn-filtro').forEach(b => b.classList.remove('active'));
  this.classList.add('active');
  const periodo = this.dataset.periodo;
  
  // Usamos la hora local del navegador para todo
  const hoy = new Date();
  let inicio = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate()); // Inicio del día de hoy
  let fin = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate()); // Fin del día de hoy

  if (periodo === 'ayer') {
    inicio.setDate(hoy.getDate() - 1);
    fin.setDate(hoy.getDate() - 1);
  } else if (periodo === 'semana') {
    inicio.setDate(hoy.getDate() - 6);
  } else if (periodo === 'mes_actual') {
    inicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
  } else if (periodo === 'mes_anterior') {
    inicio = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
    fin = new Date(hoy.getFullYear(), hoy.getMonth(), 0);
  }
  
  // Función de ayuda para formatear a YYYY-MM-DD
  const aISO = (date) => {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  };

  document.getElementById('fecha-inicio').value = aISO(inicio);
  document.getElementById('fecha-fin').value = aISO(fin);
  
  actualizarDashboard();
}



  function actualizarDashboard() {
    const inicioStr = document.getElementById('fecha-inicio').value;
    const finStr = document.getElementById('fecha-fin').value;
    if (!inicioStr || !finStr) { return; }
    setLoadingState(true);
    const inicio = new Date(inicioStr); const fin = new Date(finStr);
    const diffDias = (fin - inicio) / (1000 * 3600 * 24);
    const inicioComp = new Date(inicio); inicioComp.setDate(inicio.getDate() - diffDias - 1);
    const finComp = new Date(fin); finComp.setDate(fin.getDate() - diffDias - 1);
    const aISO = date => date.toISOString().split('T')[0];
    Promise.all([
      llamarBackend('obtenerDatosDashboard', {inicio: aISO(inicio), fin: aISO(fin)}),
      llamarBackend('obtenerDatosDashboard', {inicio: aISO(inicioComp), fin: aISO(finComp)})
    ]).then(([datosAct, datosComp]) => {
      renderizarDatosDashboard(datosAct, datosComp);
      setLoadingState(false);
    }).catch(showError);
  }
  



function renderizarDatosDashboard(datosActuales, datosComparacion) {
    actualizarFechaUltimoDato();
    const kpiActual = datosActuales.kpis;
    const kpiComp = datosComparacion.kpis;
    
    document.getElementById('kpi-ventas').textContent = '$' + kpiActual.totalVentasNetas.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    document.getElementById('kpi-ordenes').textContent = kpiActual.totalOrdenes.toLocaleString('es-AR');
    // --- KPIs de Visitas y Conversión ya no se actualizan ---
    document.getElementById('kpi-publicidad').textContent = '$' + kpiActual.totalCostoPublicidad.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    document.getElementById('kpi-acos').textContent = kpiActual.acos.toFixed(2) + '%';

    setTrendIndicator('kpi-ventas-comp', kpiActual.totalVentasNetas, kpiComp.totalVentasNetas);
    setTrendIndicator('kpi-ordenes-comp', kpiActual.totalOrdenes, kpiComp.totalOrdenes);
    // --- Tendencias de Visitas y Conversión ya no se actualizan ---
    setTrendIndicator('kpi-publicidad-comp', kpiActual.totalCostoPublicidad, kpiComp.totalCostoPublicidad);
    setTrendIndicator('kpi-acos-comp', kpiComp.acos, kpiActual.acos);
    
    drawDashboardChart(datosActuales.chartData);
  }



function drawDashboardChart(chartData) {
  if (!chartData || chartData.length <= 1) { 
    document.getElementById('line_chart_div').innerHTML = '<div class="loading">No hay datos para graficar en este período.</div>';
    return;
  }
  var data = google.visualization.arrayToDataTable(chartData);
  
  // --- OPCIONES PARA GRÁFICO DE COLUMNAS APILADAS ---
  var options = {
    title: 'Ventas Netas y Publicidad por Día',
    backgroundColor: 'transparent',
    legend: { position: 'bottom' },
    
    // 1. La opción más importante: activa el apilamiento de las barras
    isStacked: true, 
    
    // 2. Definimos un solo eje vertical para el total
    vAxis: {
      title: 'Monto ($)',
      format: 'short' 
    },
    hAxis: { 
      textStyle: { color: '#666' } 
    },

    // 3. Asignamos los colores para cada segmento de la barra
    series: {
      0: { color: '#0092FF' }, // Color para Ventas (más oscuro, base)
      1: { color: '#73C2FF' }  // Color para Publicidad (tono más claro del mismo color)
    }
  };
  
  // 4. Cambiamos el tipo de gráfico de LineChart a ColumnChart
  var chart = new google.visualization.ColumnChart(document.getElementById('line_chart_div'));
  chart.draw(data, options);
}
  

// ▼▼▼ REEMPLAZA esta función ▼▼▼
function handleForzarActualizacion() {
  const btn = document.getElementById('btn-forzar-actualizacion-completa');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i><span> Iniciando...</span>';
  
  mostrarModal('Actualización en Curso', 'Se ha iniciado el proceso de actualización por pasos. Esto puede tardar varios minutos. Puedes seguir usando la app mientras tanto.');
  
  google.script.run
    .withSuccessHandler(() => {
      // La función solo dispara el proceso, por lo que responde rápido
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-sync-alt"></i><span> Forzar Actualización</span>';
      // Actualizamos la hora de "Último Intento" inmediatamente
      actualizarFechaUltimoDato(); 
    })
    .withFailureHandler(showError)
    .dispararActualizacionPorPasos(); // Llamamos a nuestro nuevo disparador
}



  // --- LÓGICA CALCULADORA DE ENVÍOS ---
  function handleCalcularClick() {
    const modal = document.getElementById('modal-fecha-colecta');
    modal.style.display = 'flex';
    const manana = new Date(); manana.setDate(manana.getDate() + 1);
    document.getElementById('input-fecha-colecta').valueAsDate = manana;
    document.getElementById('btn-cancelar-colecta').onclick = () => modal.style.display = 'none';
    document.getElementById('btn-confirmar-colecta').onclick = () => {
      const fechaColecta = document.getElementById('input-fecha-colecta').value;
      if (!fechaColecta) { mostrarModal('Atención', 'Debes seleccionar una fecha.'); return; }
      window.fechaColectaCalculada = fechaColecta;
      modal.style.display = 'none';
      const btn = document.getElementById('btn-calcular-envios');
      btn.disabled = true; btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i><span>Calculando...</span>';
      document.getElementById('sugerencias-tabla-div').innerHTML = '<div class="loading"><span>Procesando...</span></div>';
      const parametros = { tt: parseFloat(document.getElementById('tiempoTransito').value) || 0, fe: parseFloat(document.getElementById('frecuenciaEnvio').value) || 0, z: parseFloat(document.getElementById('nivelServicio').value) || 0, fechaColecta: fechaColecta };
      google.script.run.withSuccessHandler(() => {
        google.script.run.withSuccessHandler(data => {
            drawSugerenciasTable(data);
            btn.disabled = false; btn.innerHTML = '<i class="fas fa-calculator"></i><span>Calcular Sugerencias</span>';
        }).withFailureHandler(showError).obtenerSugerenciasParaWebapp();
      }).withFailureHandler(showError).actualizarYCalcularSugerencias(parametros);
    };
  }

  

  function drawSugerenciasTable(dataFromServer) {
    const tablaDiv = document.getElementById('sugerencias-tabla-div');
    if (!dataFromServer || dataFromServer.length <= 1) { tablaDiv.innerHTML = '<div class="loading"><span>No hay sugerencias.</span></div>'; return; }
    const headers = dataFromServer.shift();
    headers[7] = "A ENVIAR (Editable)";
    headers.unshift('Sel.');
    const dataWithInputs = dataFromServer.map(row => {
      const newRow = [...row];
      newRow.unshift(`<input type="checkbox" class="fila-seleccionada" data-sku="${newRow[0]}">`);
      newRow[8] = `<input type="number" class="cantidad-a-enviar" value="${newRow[7]}" min="0" style="width: 70px; text-align: right;">`;
      return newRow;
    });
    const finalData = [headers, ...dataWithInputs];
    const data = google.visualization.arrayToDataTable(finalData);
    const table = new google.visualization.Table(tablaDiv);
    table.draw(data, { allowHtml: true, width: '100%', sort: 'disable', cssClassNames: { headerRow: 'google-visualization-table-th', tableCell: 'google-visualization-table-td' } });
    document.getElementById('registro-container').style.display = 'flex';
    document.getElementById('filtro-container').style.display = 'flex';
    setupSugerenciasTableListeners();
  }


// ▼▼▼ REEMPLAZA LAS DOS FUNCIONES DE FILTRADO CON ESTE BLOQUE ▼▼▼

function setupSugerenciasTableListeners() {
  console.log("Activando listeners para la tabla de sugerencias...");
  document.getElementById('seleccionar-todo-sugerencias').addEventListener('click', e => {
    document.querySelectorAll('#sugerencias-tabla-div .fila-seleccionada').forEach(cb => {
      if (cb.closest('tr').style.display !== 'none') {
        cb.checked = e.target.checked;
      }
    });
  });

  document.querySelectorAll('#filtro-container .btn-filtro').forEach(btn => {
    btn.addEventListener('click', e => {
      document.querySelectorAll('#filtro-container .btn-filtro').forEach(b => b.classList.remove('active'));
      e.currentTarget.classList.add('active');
      filtrarTablaSugerencias();
    });
  });

  document.getElementById('input-buscar-sugerencia').addEventListener('input', filtrarTablaSugerencias);
}

// ▼▼▼ REEMPLAZA ESTA FUNCIÓN CON LA VERSIÓN MEJORADA ▼▼▼
function filtrarTablaSugerencias() {
  const inputBusqueda = document.getElementById('input-buscar-sugerencia');
  const botonActivo = document.querySelector('#filtro-container .btn-filtro.active');
  const tabla = document.getElementById('sugerencias-tabla-div').querySelector('table');

  // Si alguno de los elementos no está listo, no hacemos nada para evitar errores.
  if (!inputBusqueda || !botonActivo || !tabla) return; 

  // CORRECCIÓN: Convertimos todo a minúsculas desde el principio.
  const textoBusqueda = inputBusqueda.value.toLowerCase().trim();
  const filtroRiesgoActivo = botonActivo.dataset.filtro.toLowerCase();
  
  const filas = tabla.querySelectorAll('tbody tr');

  filas.forEach(fila => {
    // Índices: Checkbox(0), SKU(1), Título(2), ..., Riesgo(9)
    const sku = fila.cells[1].textContent.toLowerCase();
    const titulo = fila.cells[2].textContent.toLowerCase();
    const riesgo = fila.cells[9].textContent.trim().toLowerCase(); // También convertimos el riesgo de la tabla

    const coincideRiesgo = (filtroRiesgoActivo === 'todos' || riesgo === filtroRiesgoActivo);
    const coincideTexto = (textoBusqueda === '' || sku.includes(textoBusqueda) || titulo.includes(textoBusqueda));

    if (coincideRiesgo && coincideTexto) {
      fila.style.display = '';
    } else {
      fila.style.display = 'none';
    }
  });
  
  document.getElementById('seleccionar-todo-sugerencias').checked = false;
}





  function handleRegistrarEnvioClick() {
    const checkboxes = document.querySelectorAll('.fila-seleccionada:checked');
    if (checkboxes.length === 0) { mostrarModal('Atención', 'Selecciona al menos un producto.'); return; }
    const modal = document.getElementById('modal-fecha-colecta');
    modal.style.display = 'flex';
    document.getElementById('input-fecha-colecta').value = window.fechaColectaCalculada || new Date().toISOString().split('T')[0];
    document.getElementById('btn-cancelar-colecta').onclick = () => modal.style.display = 'none';
    document.getElementById('btn-confirmar-colecta').onclick = () => {
      const fechaColecta = document.getElementById('input-fecha-colecta').value;
      if (!fechaColecta) { mostrarModal('Atención', 'Debes seleccionar una fecha.'); return; }
      modal.style.display = 'none';
      const productosParaEnviar = [];
      checkboxes.forEach(cb => {
        const fila = cb.closest('tr');
        const titulo = fila.cells[2].textContent;
        const inputCantidad = fila.querySelector('.cantidad-a-enviar');
        const cantidad = parseInt(inputCantidad.value);
        if (cantidad > 0) { productosParaEnviar.push({ sku: cb.dataset.sku, titulo: titulo, cantidad: cantidad }); }
      });
      if (productosParaEnviar.length === 0) { mostrarModal('Atención', 'No hay productos con cantidad > 0.'); return; }
      const btn = document.getElementById('btn-registrar-envio');
      btn.disabled = true; btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i><span>Registrando...</span>';
      google.script.run.withSuccessHandler(mensaje => {
          mostrarModal('Éxito', mensaje, [], 'info', 2500);
          btn.disabled = false; btn.innerHTML = '<i class="fas fa-save"></i><span>Registrar Envío</span>';
          document.getElementById('sugerencias-tabla-div').innerHTML = '<div class="loading"><span>Presiona "Calcular" para nuevas sugerencias.</span></div>';
          document.getElementById('registro-container').style.display = 'none';
          document.getElementById('filtro-container').style.display = 'none';
        }).withFailureHandler(showError).registrarEnvio(productosParaEnviar, fechaColecta);
    };
  }




  function handleDescargarBorradorClick() {
    const btn = document.getElementById('btn-descargar-borrador');
    const checkboxes = document.querySelectorAll('.fila-seleccionada:checked');
    if (checkboxes.length === 0) { mostrarModal('Atención', 'Selecciona al menos un producto para el PDF.'); return; }
    const productosParaPdf = [];
    checkboxes.forEach(cb => {
      const fila = cb.closest('tr');
      const sku = fila.cells[1].textContent, titulo = fila.cells[2].textContent;
      const cantidad = fila.querySelector('.cantidad-a-enviar').value;
      if (parseInt(cantidad) > 0) { productosParaPdf.push({ sku, titulo, cantidad }); }
    });
    if (productosParaPdf.length === 0) { mostrarModal('Atención', 'No hay productos seleccionados con cantidad > 0.'); return; }
    btn.disabled = true; btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i><span>Generando...</span>';
    google.script.run.withSuccessHandler(resultado => {
        descargarArchivoBase64(resultado.data, resultado.filename);
        btn.disabled = false; btn.innerHTML = '<i class="fas fa-file-pdf"></i> Descargar Borrador';
      }).withFailureHandler(showError).generarPdfBorrador(productosParaPdf);
  }




  // --- LÓGICA GESTIÓN ENVÍOS ---
  function cargarVistaDeEnvios() {
    const panel = document.getElementById('panel-envios-creados');
    panel.innerHTML = '<div class="loading"><span>Cargando envíos...</span></div>';
    google.script.run.withSuccessHandler(envios => { cacheEnvios = envios; displayEnvios(envios); }).withFailureHandler(showError).obtenerEnviosRegistrados();
  }


/**
 * Maneja todos los clics en los botones de acción de las tarjetas de envío.
 * Esta es la versión completa y unificada.
 */
function handleAccionDeEnvioClick(e) {
  const targetButton = e.target.closest('button');
  if (!targetButton) return;

  const accion = targetButton.dataset.action;
  const idEnvio = targetButton.dataset.id;
  if (!accion || !idEnvio) { return; }
  
  const originalHtml = targetButton.innerHTML;
  targetButton.disabled = true; // Deshabilitamos el botón para evitar doble clic

  // --- Lógica para cada tipo de acción ---

  if (accion === 'resetear-preparacion') {
    mostrarModal('Confirmar Reseteo', `¿Estás seguro de que quieres borrar TODO el progreso de preparación del envío ${idEnvio}? Esta acción no se puede deshacer.`, [
      { texto: 'Cancelar', callback: () => { targetButton.disabled = false; } },
      { texto: 'Sí, Resetear', clase: 'btn btn-confirm', callback: () => {
        google.script.run
          .withSuccessHandler(msg => mostrarModal('Éxito', msg, [], 'info', 3000))
          .withFailureHandler(showError)
          .resetearProgresoDeEnvio(idEnvio);
      }}
    ]);
    // No reactivamos el botón aquí, el modal se encarga.

  } else if (accion === 'preparar-envio') {
    const envioSeleccionado = cacheEnvios.find(e => e.id === idEnvio);
    if (envioSeleccionado) {
      iniciarModoPreparacion(envioSeleccionado);
    } else {
      mostrarModal('Error', 'No se encontraron los datos del envío para iniciar la preparación.');
    }
    targetButton.disabled = false; // Reactivamos el botón inmediatamente

  } else if (accion === 'guardar-cambios') {
    targetButton.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
    const datos = {
      idEnvio: idEnvio,
      nuevoEstado: document.querySelector(`.estado-select[data-id="${idEnvio}"]`).value,
      nuevaFechaColecta: document.querySelector(`.input-fecha-colecta-card[data-id="${idEnvio}"]`).value,
      idMeli: document.querySelector(`.input-id-ml[data-id="${idEnvio}"]`).value,
      notas: document.querySelector(`.input-notas[data-id="${idEnvio}"]`).value,
    };
    google.script.run
      .withSuccessHandler(msg => {
        mostrarModal('Éxito', msg, [], 'info', 2000);
        cargarVistaDeEnvios(); // Recargamos la vista para reflejar cambios
      })
      .withFailureHandler(err => {
        showError(err);
        targetButton.disabled = false;
        targetButton.innerHTML = originalHtml;
      })
      .actualizarDatosEnvio(datos);

  } else if (accion === 'editar-productos') {
    abrirModalEdicion(idEnvio);
    targetButton.disabled = false; // Reactivamos el botón inmediatamente

  } else if (accion === 'eliminar-envio') {
    targetButton.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
    mostrarModal('Confirmar Eliminación', `¿Estás seguro de que quieres eliminar el envío ${idEnvio}?`, [
      { texto: 'Cancelar', callback: () => {
          targetButton.disabled = false;
          targetButton.innerHTML = originalHtml;
      }},
      { texto: 'Sí, Eliminar', clase: 'btn btn-confirm', tipo: 'alert', callback: () => {
          google.script.run
            .withSuccessHandler(msg => {
              mostrarModal('Éxito', msg, [], 'info', 2000);
              cargarVistaDeEnvios();
            })
            .withFailureHandler(err => {
              showError(err);
              targetButton.disabled = false;
              targetButton.innerHTML = originalHtml;
            })
            .eliminarEnvio(idEnvio);
      }}
    ], 'alert');
  } else {
    // Si la acción no es ninguna de las conocidas, reactivamos el botón
    targetButton.disabled = false;
  }
}
  




  function abrirModalEdicion(idEnvio) {
    const btnGuardar = document.getElementById('btn-guardar-cambios-envio');
    btnGuardar.disabled = false; btnGuardar.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
    const envio = cacheEnvios.find(e => e.id === idEnvio);
    if (!envio) { mostrarModal('Error', 'No se encontraron los datos del envío.'); return; }
    document.getElementById('modal-titulo-envio').textContent = `Editando Productos: ${idEnvio}`;
    const tablaDiv = document.getElementById('modal-tabla-productos'), datalist = document.getElementById('lista-productos');
    datalist.innerHTML = ''; tablaDiv.innerHTML = '<div class="loading"><span>Cargando...</span></div>';
    document.getElementById('modal-edicion-envio').style.display = 'flex';
    google.script.run.withSuccessHandler(todosLosProductos => {
        const skusEnEnvio = new Set(envio.productos.map(p => p.sku));
        const productosDisponibles = todosLosProductos.filter(p => !skusEnEnvio.has(p.sku));
        datalist.innerHTML = productosDisponibles.map(p => `<option value="${p.sku}">${p.titulo}</option>`).join('');
        let tablaHtml = '<table id="tabla-edicion-productos" style="width:100%;">...</table>'; // (HTML interno omitido por brevedad)
        tablaDiv.innerHTML = tablaHtml;
      }).withFailureHandler(showError).obtenerTodosLosProductosParaSelector();
    document.getElementById('btn-cancelar-edicion').onclick = () => document.getElementById('modal-edicion-envio').style.display = 'none';
    tablaDiv.onclick = e => { if (e.target.closest('.btn-eliminar-producto')) e.target.closest('tr').remove(); };
    document.getElementById('btn-guardar-cambios-envio').onclick = () => { /* ... lógica de guardado ... */ };
    document.getElementById('btn-agregar-producto').onclick = () => { /* ... lógica de agregar producto ... */ };
  }

//===================================================================================================================
// --- LÓGICA GESTIÓN PRECIOS --- ----------------------------------------
//===================================================================================================================

/**
 * Función Auxiliar: Redondea eliminando decimales y forzando terminación en 3, 5, 7 o 9.
 */
function redondearPrecioPsicologico(precio) {
  // 1. Quitamos los decimales (1540.80 -> 1541)
  let entero = Math.round(precio);
  
  // 2. Miramos el último número
  let ultimoDigito = entero % 10;
  let diferencia = 0;
  
  // 3. Calculamos cuánto falta para llegar al "número mágico" más cercano (hacia arriba)
  if (ultimoDigito <= 3) {
      diferencia = 3 - ultimoDigito; // Si termina en 0, 1, 2 -> va a 3
  } else if (ultimoDigito <= 5) {
      diferencia = 5 - ultimoDigito; // Si termina en 4 -> va a 5
  } else if (ultimoDigito <= 7) {
      diferencia = 7 - ultimoDigito; // Si termina en 6 -> va a 7
  } else {
      diferencia = 9 - ultimoDigito; // Si termina en 8 -> va a 9
  }
  
  return entero + diferencia;
}


// ▼▼▼ REEMPLAZA tu función cargarVistaDePrecios ▼▼▼
function cargarVistaDePrecios() {
  const tablaDiv = document.getElementById('tabla-precios-div');
  // Eliminamos la caché para asegurar datos frescos siempre en esta etapa de depuración
  cachePrecios = []; 
  
  tablaDiv.innerHTML = '<div class="loading"><i class="fas fa-circle-notch spinner"></i><span>Cargando datos de precios y comisiones...</span></div>';
  
  google.script.run
    .withSuccessHandler(data => {
      // --- LÍNEA DE DEPURACIÓN AÑADIDA ---
      console.log("Datos recibidos del servidor para la tabla de precios:", data);
      
      cachePrecios = data; 
      drawPreciosTable(data); 
    })
    .withFailureHandler(showError)
    .obtenerDesgloseDeCargos();
}

  /**
 * Dibuja la tabla en la sección de Gestión de Precios con todas las columnas de rentabilidad.
 * @param {Array<Object>} data - Los datos de los productos con sus cargos.
 */
function drawPreciosTable(data) {
  const tablaDiv = document.getElementById('tabla-precios-div');
  if (!data || data.length === 0) {
    tablaDiv.innerHTML = '<div class="loading">No se encontraron productos.</div>';
    return;
  }
  
  const dataTable = new google.visualization.DataTable();
  dataTable.addColumn('string', '<input type="checkbox" id="seleccionar-todo-precios">');
  dataTable.addColumn('string', 'SKU');
  dataTable.addColumn('string', 'Título');
  dataTable.addColumn('string', 'Precio Lista (Editable)');
  dataTable.addColumn('number', 'Comisión ML');
  dataTable.addColumn('number', 'Cargo Fijo');
  dataTable.addColumn('number', 'Costo Envío');
  dataTable.addColumn('number', 'Impuestos');
  dataTable.addColumn('number', 'Neto Estimado');
  dataTable.addColumn('string', 'Promo Activa');
  dataTable.addColumn('number', 'Precio Promo');
  dataTable.addColumn('number', 'Neto c/Promo');

  const rows = data.map(item => {
    const estado = item.estado_publicacion || 'desconocido';
    const indicadorHtml = `<span class="status-indicator status-${estado.toLowerCase()}" title="Estado: ${estado}"></span>`;
    const tituloConIndicador = `${indicadorHtml} ${item.titulo}`;

    const checkbox = `<input type="checkbox" class="fila-precio-seleccionada" data-item-id="${item.item_id}">`;
    const isDisabled = item.tiene_promo ? 'disabled' : '';
    const inputTitle = item.tiene_promo ? 'El precio está bloqueado por una promoción activa' : 'Puedes editar este precio';
    const precioDeLista = item.precio_lista;
    const precioInput = `<input type="number" class="precio-editable" data-item-id="${item.item_id}" data-sku="${item.sku}" value="${(precioDeLista || 0).toFixed(2)}" style="width: 100px; text-align: right; padding: 4px; border: 1px solid #ccc; border-radius: 4px;" ${isDisabled} title="${inputTitle}">`;
    const promoIndicator = item.tiene_promo ? '<span style="color: var(--secondary-color); font-weight: bold;">✔ Sí</span>' : '<span style="color: var(--text-light);">No</span>';

    return [
      checkbox, item.sku, tituloConIndicador, precioInput,
      item.comision, item.cargo_fijo,
      item.costo_envio, item.impuestos,
      item.neto_lista,
      promoIndicator,
      item.precio_promo,
      item.neto_promo
    ];
  });
  dataTable.addRows(rows);
  
  const table = new google.visualization.Table(tablaDiv);
  const formatter = new google.visualization.NumberFormat({ prefix: '$', decimalSymbol: ',', groupingSymbol: '.', fractionDigits: 2 });
  for (let i = 4; i <= 8; i++) { formatter.format(dataTable, i); }
  formatter.format(dataTable, 10);
  formatter.format(dataTable, 11);

  table.draw(dataTable, { allowHtml: true, width: '100%', height: '100%', sort: 'disable', cssClassNames: { headerRow: 'google-visualization-table-th', tableCell: 'google-visualization-table-td' } });
  
  const selectAllCheckbox = document.getElementById('seleccionar-todo-precios');
  if(selectAllCheckbox) {
    selectAllCheckbox.addEventListener('click', e => {
      document.querySelectorAll('#tabla-precios-div .fila-precio-seleccionada').forEach(cb => {
        if (cb.closest('tr').style.display !== 'none') { cb.checked = e.target.checked; }
      });
    });
  }
}



  function handleBusquedaProducto() {
    const textoBusqueda = this.value.toLowerCase().trim();
    const tabla = document.getElementById('tabla-precios-div').querySelector('table');
    const filas = tabla.querySelectorAll('tbody tr');
    filas.forEach(fila => {
      const sku = fila.cells[1].textContent.toLowerCase();
      const titulo = fila.cells[2].textContent.toLowerCase();
      if (sku.includes(textoBusqueda) || titulo.includes(textoBusqueda)) {
        fila.style.display = '';
      } else {
        fila.style.display = 'none';
      }
    });
  }



/**
 * Nueva función para resetear los precios a su estado original.
 */
function handleResetearPrecios() {
    if (cachePrecios.length > 0) {
        drawPreciosTable(cachePrecios); // Vuelve a dibujar la tabla con los datos originales
        mostrarModal('Información', 'Los cambios no guardados han sido reseteados.', [], 'info', 2000);
    }
}



/**
 * Previsualiza los cambios de precio en lote CON REDONDEO PSICOLÓGICO.
 */
function handleAplicarPreciosClick() {
  const checkboxes = document.querySelectorAll('.fila-precio-seleccionada:checked');
  if (checkboxes.length === 0) { 
      mostrarModal('Atención', 'Por favor, selecciona al menos un producto para modificar.'); 
      return; 
  }
  
  const inputValor = document.getElementById('input-valor-modificacion');
  const tipoMod = document.getElementById('select-tipo-modificacion').value; // 'porcentaje' o 'fijo'
  const valorMod = parseFloat(inputValor.value);
  
  if (isNaN(valorMod)) { 
      mostrarModal('Atención', 'Ingresa un valor numérico para la modificación.'); 
      return; 
  }

  let contadorCambios = 0;

  checkboxes.forEach(cb => {
    const itemId = cb.dataset.itemId;
    // Buscamos el input de la celda para escribir el nuevo valor
    const inputPrecio = document.querySelector(`.precio-editable[data-item-id="${itemId}"]`);
    // Buscamos el dato original en la "memoria" (cachePrecios) para no acumular errores
    const productoOriginal = cachePrecios.find(p => p.item_id === itemId); 

    if (inputPrecio && productoOriginal) {
      const precioBase = productoOriginal.precio_lista; // Precio original
      let precioCalculado = 0;

      // 1. Hacemos la matemática normal
      if (tipoMod === 'porcentaje') {
        precioCalculado = precioBase * (1 + valorMod / 100);
      } else {
        precioCalculado = precioBase + valorMod;
      }
      
      // 2. APLICAMOS LA MAGIA: Redondeo 3, 5, 7, 9
      const nuevoPrecioFinal = redondearPrecioPsicologico(precioCalculado);

      // 3. Mostramos el resultado en la tabla
      inputPrecio.value = nuevoPrecioFinal.toFixed(2); // Ponemos .00 solo por estética
      
      // 4. Cambiamos el color para que se note que cambió
      inputPrecio.style.backgroundColor = '#fff3cd'; // Fondo amarillo suave
      inputPrecio.style.color = '#856404'; // Texto oscuro
      inputPrecio.style.fontWeight = 'bold';
      
      contadorCambios++;
    }
  });

  mostrarModal('Cálculo Realizado', `Se han recalculado y redondeado ${contadorCambios} precios.`);
}



/**
 * Guarda en Mercado Libre los precios modificados.
 * MEJORA: Si hay errores, permite revisar la tabla sin recargarla automáticamente.
 */
function handleGuardarPreciosClick() {
    const inputsModificados = document.querySelectorAll('.precio-editable');
    const productosAActualizar = [];

    // 1. Detectar cambios
    inputsModificados.forEach(input => {
        const itemId = input.dataset.itemId;
        const sku = input.dataset.sku;
        const nuevoPrecio = parseFloat(input.value);
        
        const productoOriginal = cachePrecios.find(p => p.item_id === itemId);
        
        if (productoOriginal && nuevoPrecio.toFixed(2) !== parseFloat(productoOriginal.precio_lista).toFixed(2)) {
            productosAActualizar.push({ itemId, sku, nuevoPrecio });
        }
    });

    if (productosAActualizar.length === 0) {
        mostrarModal('Información', 'No hay precios modificados para guardar.');
        return;
    }

    // 2. Confirmar acción
    mostrarModal('Confirmar Acción', `Vas a guardar ${productosAActualizar.length} precios modificados en Mercado Libre. ¿Continuar?`,
        [{ texto: 'Cancelar' },
        {
            texto: 'Confirmar', clase: 'btn btn-confirm', callback: () => {
                const btn = document.getElementById('btn-guardar-precios');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Guardando...';
                
                // 3. Llamar al servidor
                google.script.run
                    .withSuccessHandler(resultado => {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios en ML';

                        let mensaje = `Proceso finalizado.\nExitosos: ${resultado.exitos}\nFallidos: ${resultado.fallidos.length}`;
                        let botonesModal = [];

                        // 4. Manejar Errores Visualmente
                        if (resultado.fallidos.length > 0) {
                            mensaje += `\n\nATENCIÓN: Algunos productos no se pudieron actualizar. Las filas se han marcado en ROJO para que las revises.`;
                            
                            // Pintamos las filas con error
                            resultado.fallidos.forEach(fallido => {
                                const inputFallido = document.querySelector(`.precio-editable[data-item-id="${fallido.itemId}"]`);
                                if (inputFallido) {
                                    const fila = inputFallido.closest('tr');
                                    fila.style.backgroundColor = '#ffcccc'; // Rojo suave
                                    fila.title = `Error: ${fallido.error}`; // Tooltip con el mensaje de error
                                    
                                    // También añadimos un icono de alerta visual
                                    const celdaTitulo = fila.cells[2];
                                    if(!celdaTitulo.innerHTML.includes('fa-exclamation-circle')) {
                                        celdaTitulo.innerHTML += ` <i class="fas fa-exclamation-circle" style="color:red;" title="${fallido.error}"></i>`;
                                    }
                                }
                            });

                            // --- CAMBIO CLAVE: Botones si hay error ---
                            botonesModal = [
                                { 
                                    texto: 'Cerrar y Revisar Errores', // NO recarga la tabla
                                    clase: 'btn btn-secondary',
                                    callback: () => { /* Solo cierra el modal */ }
                                },
                                { 
                                    texto: 'Ignorar y Recargar Tabla', // SÍ recarga
                                    clase: 'btn',
                                    callback: () => { 
                                        cachePrecios = []; 
                                        cargarVistaDePrecios(); 
                                    }
                                }
                            ];

                        } else {
                            // --- Caso Éxito Total: Botón normal ---
                            mensaje = "¡Todos los precios se actualizaron correctamente!";
                            botonesModal = [{
                                texto: 'Aceptar y Recargar',
                                clase: 'btn btn-confirm',
                                callback: () => {
                                    cachePrecios = [];
                                    cargarVistaDePrecios();
                                }
                            }];
                        }
                        
                        mostrarModal(
                            resultado.fallidos.length > 0 ? '⚠️ Proceso con Alertas' : '✅ Proceso Exitoso', 
                            mensaje, 
                            botonesModal,
                            resultado.fallidos.length > 0 ? 'alert' : 'success' // Tipo de modal
                        );
                    })
                    .withFailureHandler(err => {
                        showError(err);
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios en ML';
                    })
                    .actualizarPreciosEnLote(productosAActualizar);
            }
        }],
        'confirm'
    );
}



function handleForzarRecalculoClick() {
  mostrarModal('Confirmar Recálculo', 'Esta acción borrará y volverá a consultar a la API todos los costos de tus publicaciones. El proceso puede ser lento. ¿Estás seguro?',
    [ { texto: 'Cancelar' },
      { texto: 'Sí, Recalcular Todo', clase: 'btn btn-confirm', callback: () => {
          document.getElementById('tabla-precios-div').innerHTML = '<div class="loading"><i class="fas fa-circle-notch spinner"></i><span>Forzando recálculo... Este proceso puede tardar varios minutos.</span></div>';
          
          // Ahora llamamos a la nueva función unificada
          google.script.run
            .withSuccessHandler(datosRecalculados => {
                cachePrecios = datosRecalculados; // Actualizamos la caché del cliente con los datos frescos
                drawPreciosTable(datosRecalculados); // Dibujamos la tabla con los nuevos datos
            })
            .withFailureHandler(showError)
            .recalcularYObtenerCargos(); // El nombre de la nueva función del servidor
      }}]
  );
}

function setupPreciosTableListeners() {
  // Listener para "Seleccionar Todo" de la tabla de precios
  document.getElementById('seleccionar-todo-precios').addEventListener('click', e => {
    document.querySelectorAll('#tabla-precios-div .fila-precio-seleccionada').forEach(cb => {
      if (cb.closest('tr').style.display !== 'none') { cb.checked = e.target.checked; }
    });
  });
}




// ▼▼▼ AÑADE esta nueva función ▼▼▼
function filtrarTablaPrecios() {
  const textoBusqueda = document.getElementById('input-buscar-producto').value.toLowerCase().trim();
  const filtroEstadoActivo = document.querySelector('.btn-filtro-estado.active').dataset.filtro;
  const tabla = document.getElementById('tabla-precios-div').querySelector('table');
  if (!tabla) return;
  
  const filas = tabla.querySelectorAll('tbody tr');
  filas.forEach(fila => {
    const tituloHtml = fila.cells[2].innerHTML;
    const sku = fila.cells[1].textContent.toLowerCase();
    const titulo = fila.cells[2].textContent.toLowerCase();

    // Extraemos el estado del 'title' del indicador de círculo
    const match = tituloHtml.match(/title="Estado: (.*?)"/);
    const estado = match ? match[1].toLowerCase() : 'desconocido';

    const coincideEstado = (filtroEstadoActivo === 'todos' || estado === filtroEstadoActivo);
    const coincideTexto = (textoBusqueda === '' || sku.includes(textoBusqueda) || titulo.includes(textoBusqueda));

    if (coincideEstado && coincideTexto) {
      fila.style.display = '';
    } else {
      fila.style.display = 'none';
    }
  });
  document.getElementById('seleccionar-todo-precios').checked = false;
}





// ===================================================================================================================================
// --- LOGICA DE ENVIOS  ---
//===================================================================================================================

  
  function cargarVistaDeEnvios() {
    const panel = document.getElementById('panel-envios-creados');
    panel.innerHTML = '<div class="loading"><i class="fas fa-circle-notch spinner"></i><span>Cargando envíos...</span></div>';
    google.script.run
      .withSuccessHandler(envios => {
        cacheEnvios = envios; // Guardamos en caché
        displayEnvios(envios);
      })
      .withFailureHandler(showError)
      .obtenerEnviosRegistrados();
  }


/**
 * Dibuja las tarjetas de envío con el diseño y la funcionalidad completos,
 * incluyendo los botones de acción para preparar y resetear.
 */
function displayEnvios(envios) {
  const panel = document.getElementById('panel-envios-creados');
  if (!envios || envios.length === 0) {
    panel.innerHTML = '<div class="loading">No se encontraron envíos registrados.</div>';
    return;
  }
  let html = '';
  envios.forEach(envio => {
    const fechaCreacion = new Date(envio.fechaCreacion);
    const fechaColecta = new Date(envio.fechaColecta);
    const fechaColectaISO = fechaColecta.getFullYear() + '-' + ('0' + (fechaColecta.getMonth() + 1)).slice(-2) + '-' + ('0' + fechaColecta.getDate()).slice(-2);
    
    const fechaCreacionDisplay = fechaCreacion.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit' });
    const fechaColectaDisplay = fechaColecta.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit' });

    const totalBultos = envio.productos.reduce((sum, p) => sum + parseInt(p.cantidad, 10), 0);

    let statusClass = '', statusColor = 'var(--primary-color)';
    if (envio.estado === 'En Preparación') {
      statusClass = 'card-status-preparacion';
      statusColor = 'var(--warning-color)';
    } else if (envio.estado === 'Despachado') {
      statusClass = 'card-status-despachado';
      statusColor = 'var(--primary-color)';
    } else if (envio.estado === 'Recibido') {
      statusClass = 'card-status-recibido';
      statusColor = 'var(--secondary-color)';
    }
    
    html += `
      <div class="card ${statusClass}" style="margin-bottom: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div>
            <h3 style="margin: 0;">ID: ${envio.id}</h3>
          </div>
          <div style="text-align: right;">
            <span style="font-weight: bold; font-size: 16px; padding: 6px 12px; border-radius: 8px; background-color: rgba(0,0,0,0.05); color: ${statusColor};">${envio.estado}</span>
          </div>
        </div>

        <div style="display: flex; justify-content: space-around; text-align: center; margin: 24px 0;">
          <div>
            <div style="font-size: 14px; color: var(--text-light); margin-bottom: 4px;">Fecha Creación</div>
            <div style="font-size: 24px; font-weight: 600;">${fechaCreacionDisplay}</div>
          </div>
          <div>
            <div style="font-size: 14px; color: var(--text-light); margin-bottom: 4px;">Fecha Colecta</div>
            <div style="font-size: 24px; font-weight: 600;">${fechaColectaDisplay}</div>
          </div>
          <div>
            <div style="font-size: 14px; color: var(--text-light); margin-bottom: 4px;">Bultos Totales</div>
            <div style="font-size: 24px; font-weight: 600;">${totalBultos}</div>
          </div>
        </div>

        <hr style="margin: 16px 0; border: 0; border-top: 1px solid var(--border-color);">
        
        <h4>Productos (${envio.productos.length})</h4>
        <ul style="list-style: none; padding: 0; margin-top: 8px; max-height: 150px; overflow-y: auto;">`;
    envio.productos.forEach(p => {
      html += `<li style="display: flex; justify-content: space-between; padding: 4px 0;"><span>${p.sku} - <i style="color: var(--text-light);">${p.titulo}</i></span><strong>${p.cantidad} uds.</strong></li>`;
    });
    html += `</ul>

        <div style="margin-top: 24px; border-top: 1px solid var(--border-color); padding-top: 16px; display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
          <select class="estado-select" data-id="${envio.id}" style="padding: 8px; border-radius: 8px; border: 1px solid var(--border-color);"><option value="En Preparación" ${envio.estado === 'En Preparación' ? 'selected' : ''}>En Preparación</option><option value="Despachado" ${envio.estado === 'Despachado' ? 'selected' : ''}>Despachado</option><option value="Recibido" ${envio.estado === 'Recibido' ? 'selected' : ''}>Recibido</option></select>
          <input type="date" class="input-fecha-colecta-card" value="${fechaColectaISO}" data-id="${envio.id}" style="padding: 7px; border-radius: 8px; border: 1px solid var(--border-color);">
          <input type="text" class="input-id-ml" placeholder="ID de Envío ML" value="${envio.idML !== '-' ? envio.idML : ''}" data-id="${envio.id}" style="padding: 8px; border-radius: 8px; border: 1px solid var(--border-color);">
          <input type="text" class="input-notas" placeholder="Notas..." value="${envio.notas}" data-id="${envio.id}" style="padding: 8px; border-radius: 8px; border: 1px solid var(--border-color); flex-grow: 1;">
          
          <div style="margin-left: auto; display:flex; gap:10px;">
            <button class="btn" data-action="resetear-preparacion" data-id="${envio.id}" ${envio.estado !== 'En Preparación' ? 'disabled' : ''} title="Resetear progreso de preparación a cero">
              <i class="fas fa-undo"></i>
            </button>
            <button class="btn btn-secondary" data-action="preparar-envio" data-id="${envio.id}" ${envio.estado !== 'En Preparación' ? 'disabled' : ''} title="Iniciar preparación de este envío">
              <i class="fas fa-box-open"></i> Preparar
            </button>
            <a href="${envio.linkPdf}" target="_blank" class="btn" style="background-color:#6c757d; ${!envio.linkPdf || envio.linkPdf.includes('Error') ? 'display:none;' : ''}" title="Imprimir PDF">
              <i class="fas fa-print"></i>
            </a>
            <button class="btn" data-action="editar-productos" data-id="${envio.id}" ${envio.estado !== 'En Preparación' ? 'disabled' : ''} title="Editar lista de productos">
              <i class="fas fa-pencil-alt"></i>
            </button>
            <button class="btn" data-action="guardar-cambios" data-id="${envio.id}" style="background-color:#007bff;" title="Guardar cambios de estado, fecha, etc.">
              <i class="fas fa-save"></i>
            </button>
            <button class="btn" data-action="eliminar-envio" data-id="${envio.id}" style="background-color: var(--danger-color);" title="Eliminar este envío">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      </div>`;
  });
  panel.innerHTML = html;
}


/**
 * Inicia el Modo Preparación para un envío específico.
 * VERSIÓN COMPLETA: Llama al servidor, puebla la interfaz, activa el escáner
 * y conecta los botones de acción "Finalizar" y "Cancelar", incluyendo la
 * lógica para detener el temporizador de limpieza automática.
 * @param {Object} envio - El objeto del envío seleccionado.
 */
function iniciarModoPreparacion(envio) {
  envioEnPreparacionId = envio.id;
  handleMenuClick('seccion-modo-preparacion', null);
  document.getElementById('page-title').textContent = 'Modo Preparación de Envío';
  document.getElementById('titulo-preparacion-envio').textContent = `Cargando preparación para envío: ${envio.id}...`;
  document.getElementById('tabla-preparacion').querySelector('tbody').innerHTML = '<tr><td colspan="5" class="loading"><span>Cargando datos del servidor...</span></td></tr>';

  google.script.run
    .withSuccessHandler(productos => {
      // Cuando el servidor responde, poblamos toda la interfaz
      document.getElementById('titulo-preparacion-envio').textContent = `Preparando Envío: ${envio.id}`;
      const tablaBody = document.getElementById('tabla-preparacion').querySelector('tbody');
      tablaBody.innerHTML = ''; 

      productos.forEach(p => {
        const fila = document.createElement('tr');
        const escaneados = p.cantidad_escaneada || 0;
        const requeridos = p.cantidad_requerida || 0;
        let estadoClass = 'estado-pendiente';
        let estadoTag = '<span class="tag-estado tag-pendiente">Pendiente</span>';

        if (escaneados >= requeridos) {
          estadoClass = 'estado-completado';
          estadoTag = '<span class="tag-estado tag-completado">Completado</span>';
        } else if (escaneados > 0) {
          estadoClass = 'estado-en-progreso';
          estadoTag = '<span class="tag-estado tag-progreso">En Progreso</span>';
        }
        
        const inventoryIdLimpio = p.inventory_id ? String(p.inventory_id).trim().toUpperCase() : (p.sku || '').trim().toUpperCase();
        fila.className = estadoClass;
        fila.dataset.inventoryId = inventoryIdLimpio;

        fila.innerHTML = `
          <td><strong>${p.sku}</strong><br><small>${p.titulo}</small></td>
          <td class="inventory-id">${p.inventory_id || '<span style="color:red;">FALTA</span>'}</td>
          <td class="cant-a-enviar">${requeridos}</td>
          <td class="cant-escaneada">${escaneados}</td>
          <td class="estado-empaque">${estadoTag}</td>
        `;
        tablaBody.appendChild(fila);
      });

      // Reiniciamos la cabecera de foco y los botones a su estado inicial
      resetearFocoYEscaner();
      
      // Activamos el 'oyente' del escáner para esta sesión
      setupScannerListener();

      // --- Conectamos los botones de Finalizar y Cancelar ---
      const btnFinalizar = document.getElementById('btn-finalizar-preparacion');
      const btnCancelar = document.getElementById('btn-cancelar-preparacion');
      
      // Aseguramos que los botones estén habilitados al iniciar
      btnFinalizar.disabled = false;
      btnFinalizar.innerHTML = '<i class="fas fa-check-circle"></i> Finalizar Preparación';
      
      function salirDePreparacion() {
        clearTimeout(limpiezaTimeoutId); // Detenemos el temporizador
        handleMenuClick('seccion-gestion-envios', document.getElementById('menu-envios-creados'));
      }

      btnCancelar.onclick = salirDePreparacion;

      btnFinalizar.onclick = function() {
        clearTimeout(limpiezaTimeoutId); // Detenemos el temporizador
        btnFinalizar.disabled = true;
        btnFinalizar.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Verificando...';

        google.script.run
          .withSuccessHandler(resultado => {
            if (resultado.necesitaConfirmacion) {
              mostrarModal('Confirmar Finalización', resultado.mensaje, [
                { texto: 'No, Volver', callback: () => { 
                  btnFinalizar.disabled = false;
                  btnFinalizar.innerHTML = '<i class="fas fa-check-circle"></i> Finalizar Preparación';
                }},
                { texto: 'Sí, Finalizar y Actualizar', clase: 'btn btn-confirm', callback: () => {
                  btnFinalizar.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Finalizando...';
                  google.script.run
                    .withSuccessHandler(resFinal => {
                      mostrarModal('Éxito', resFinal.mensaje, [], 'info', 3000);
                      salirDePreparacion();
                    })
                    .withFailureHandler(showError)
                    .confirmarFinalizacionConDiscrepancias(envioEnPreparacionId);
                }}
              ]);
            } else {
              mostrarModal('Éxito', resultado.mensaje, [], 'info', 3000);
              salirDePreparacion();
            }
          })
          .withFailureHandler(showError)
          .verificarYFinalizarPreparacion(envioEnPreparacionId);
      };
    })
    .withFailureHandler(showError)
    .iniciarOReanudarPreparacion(envio.id);
}


function actualizarFilaProducto(datos) {
  const fila = document.querySelector(`#tabla-preparacion tr[data-inventory-id="${datos.inventory_id}"]`);
  if (!fila) return;

  fila.querySelector('.cant-escaneada').textContent = datos.escaneados;

  const celdaEstado = fila.querySelector('.estado-empaque');
  if (datos.escaneados >= datos.requeridos) {
    fila.className = 'estado-completado';
    celdaEstado.innerHTML = '<span class="tag-estado tag-completado">Completado</span>';
  } else if (datos.escaneados > 0) {
    fila.className = 'estado-en-progreso';
    celdaEstado.innerHTML = '<span class="tag-estado tag-progreso">En Progreso</span>';
  }
}



/**
 * Limpia el input del escáner, la cabecera de foco y deshabilita
 * los botones de ajuste, dejando la UI lista para un nuevo producto.
 */
function resetearFocoYEscaner() {
  const input = document.getElementById('input-escaner');
  if (input) {
    input.value = '';
    input.focus();
  }
  
  const foco = document.getElementById('foco-escaneo');
  if (foco) {
    foco.className = 'foco-escaneo-pendiente';
    document.getElementById('foco-titulo').textContent = 'Esperando escaneo...';
    document.getElementById('foco-sku').textContent = 'SKU: -';
    document.getElementById('foco-inventory-id').textContent = 'Inventory ID: -';
    document.getElementById('foco-contador').innerHTML = '';
  }

  const btnSumar = document.getElementById('btn-sumar-cantidad');
  if (btnSumar) btnSumar.disabled = true;

  const btnRestar = document.getElementById('btn-restar-cantidad');
  if (btnRestar) btnRestar.disabled = true;
}



function actualizarFoco(datos) {
  // --- LÓGICA DEL TEMPORIZADOR AÑADIDA ---
  // Primero, cancelamos cualquier temporizador de limpieza anterior
  clearTimeout(limpiezaTimeoutId);

  const foco = document.getElementById('foco-escaneo');
  const input = document.getElementById('input-escaner');
  const btnSumar = document.getElementById('btn-sumar-cantidad');
  const btnRestar = document.getElementById('btn-restar-cantidad');

  input.value = datos.inventory_id;
  foco.className = 'foco-escaneo-activo';
  document.getElementById('foco-titulo').textContent = datos.titulo;
  document.getElementById('foco-sku').textContent = `SKU: ${datos.sku}`;
  document.getElementById('foco-inventory-id').textContent = `Inventory ID: ${datos.inventory_id}`;
  document.getElementById('foco-contador').innerHTML = `Escaneados: <strong>${datos.escaneados} / ${datos.requeridos}</strong>`;

  btnSumar.disabled = (datos.escaneados >= datos.requeridos);
  btnRestar.disabled = (datos.escaneados <= 0);

  // Creamos un nuevo temporizador para limpiar todo después de 15 segundos de inactividad
  limpiezaTimeoutId = setTimeout(() => {
    resetearFocoYEscaner();
  }, 2000); // 15000 milisegundos = 15 segundos
}


/**
 * Procesa las tareas de la cola de guardado una por una.
 * Se asegura de que nunca haya más de una solicitud de guardado al servidor a la vez.
 */
function procesarColaDeGuardado() {
  // Si ya hay un guardado en curso, o si la cola está vacía, no hacemos nada.
  if (guardadoEnCurso || colaDeGuardado.length === 0) {
    return;
  }

  // Marcamos que estamos ocupados
  guardadoEnCurso = true;
  
  // Tomamos la primera tarea de la cola
  const tarea = colaDeGuardado.shift(); 

  google.script.run
    .withSuccessHandler(resultado => {
      // El guardado fue exitoso
      console.log('Guardado exitoso para:', tarea);
      guardadoEnCurso = false; // Marcamos que estamos libres
      procesarColaDeGuardado(); // Intentamos procesar la siguiente tarea si hay alguna
    })
    .withFailureHandler(err => {
      // Si el guardado falla, lo mostramos y detenemos la cola
      console.error('Falló el guardado para:', tarea);
      showError(err);
      guardadoEnCurso = false; // Marcamos que estamos libres para un nuevo intento
    })
    .ajustarCantidadEscaneada(tarea.idEnvio, tarea.inventoryId, tarea.ajuste);
}





/**
 * Configura los 'oyentes' para el escáner y los botones de ajuste.
 * VERSIÓN FINAL CON COOLDOWN: Implementa un bloqueo temporal después de
 * cada acción para evitar la sobrecarga del servidor y el error del "candado".
 */
function setupScannerListener() {
  const input = document.getElementById('input-escaner');
  const btnSumar = document.getElementById('btn-sumar-cantidad');
  const btnRestar = document.getElementById('btn-restar-cantidad');

  // Función interna que actualiza la UI y añade la tarea a la cola
  function procesarAjuste(ajuste) {
    // 1. Verificamos si el escáner está bloqueado (cooldown activo)
    if (escanerBloqueado) return;
    escanerBloqueado = true; // Bloqueamos inmediatamente para evitar acciones seguidas
    
    const currentId = input.value.trim().toUpperCase();
    if (!currentId) {
        escanerBloqueado = false; // Desbloqueamos si no hay nada que hacer
        return;
    }

    const fila = document.querySelector(`#tabla-preparacion tr[data-inventory-id="${currentId}"]`);
    if (!fila) {
        escanerBloqueado = false; // Desbloqueamos si el producto no está enfocado
        return;
    }

    // Lógica optimista (la UI se actualiza al instante)
    const requeridos = parseInt(fila.querySelector('.cant-a-enviar').textContent, 10);
    let escaneados = parseInt(fila.querySelector('.cant-escaneada').textContent, 10);
    const nuevaCantidad = escaneados + ajuste;

    if (nuevaCantidad > requeridos || nuevaCantidad < 0) {
      if (nuevaCantidad > requeridos) {
        document.getElementById('foco-titulo').textContent = "No se puede escanear más de lo requerido.";
      }
      escanerBloqueado = false; // Desbloqueamos si la acción no es válida
      return;
    }
    
    const datosActualizados = {
        inventory_id: currentId,
        sku: fila.cells[0].querySelector('strong').textContent,
        titulo: fila.cells[0].querySelector('small').textContent,
        escaneados: nuevaCantidad,
        requeridos: requeridos
    };
    actualizarFilaProducto(datosActualizados);
    actualizarFoco(datosActualizados);

    // Añadimos la tarea a la cola de guardado
    colaDeGuardado.push({
      idEnvio: envioEnPreparacionId,
      inventoryId: currentId,
      ajuste: ajuste
    });
    procesarColaDeGuardado(); // Le decimos al "mensajero" que revise si hay trabajo

    // 2. DESBLOQUEO AUTOMÁTICO
    // Después de un breve tiempo, volvemos a habilitar el escáner
    setTimeout(() => {
      escanerBloqueado = false;
    }, 700); // 700 milisegundos de cooldown
  }

  // Conectamos los botones a la lógica
  btnSumar.onclick = () => procesarAjuste(1);
  btnRestar.onclick = () => procesarAjuste(-1);

  // Conectamos el "Enter" del escáner/teclado
  input.onkeydown = function(event) {
    if (event.key === 'Enter') {
      event.preventDefault();
      if (escanerBloqueado) return; // Respetamos el cooldown
      
      const scannedId = input.value.trim().toUpperCase();
      if (scannedId === '') return;
      
      const fila = document.querySelector(`#tabla-preparacion tr[data-inventory-id="${scannedId}"]`);
      
      if (fila) {
        // Si el producto ya está en la lista, simplemente le sumamos 1
        procesarAjuste(1);
      } else {
        // Si es un ID nuevo, primero tenemos que pedirle los datos al servidor
        escanerBloqueado = true; // Bloqueamos mientras se busca un nuevo item
        document.getElementById('foco-titulo').innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Buscando...';
        google.script.run
          .withSuccessHandler(resultado => {
            if (resultado.success) {
              actualizarFilaProducto(resultado);
              actualizarFoco(resultado);
            } else {
              document.getElementById('foco-escaneo').className = 'foco-escaneo-pendiente';
              document.getElementById('foco-titulo').textContent = resultado.message;
              document.getElementById('foco-sku').textContent = 'SKU: -';
              document.getElementById('foco-inventory-id').textContent = 'Inventory ID: -';
              document.getElementById('foco-contador').innerHTML = '';
            }
            // Desbloqueamos después de un momento, tanto en éxito como en error de búsqueda
            setTimeout(() => { escanerBloqueado = false; input.value = ''; }, 700);
          })
          .withFailureHandler(err => {
             showError(err);
             escanerBloqueado = false; // Desbloqueamos también si hay un error grave
          })
          .registrarEscaneoDeProducto(envioEnPreparacionId, scannedId);
      }
    }
  };
}




/**
 * *** VERSIÓN CON MODAL INTEGRADO ***
 * Se activa al hacer clic en cualquier botón de acción de una tarjeta de envío.
 * Muestra un estado de carga y notificaciones con el modal personalizado.
 */
function handleAccionDeEnvioClick(e) {
  const targetButton = e.target.closest('button');
  if (!targetButton) return;

  const accion = targetButton.dataset.action;
  const idEnvio = targetButton.dataset.id;
  if (!accion || !idEnvio) { return; }
  
  const originalHtml = targetButton.innerHTML;
  targetButton.disabled = true;
  
  if (accion === 'preparar-envio') {
      const envioSeleccionado = cacheEnvios.find(e => e.id === idEnvio);
      if (envioSeleccionado) {
          iniciarModoPreparacion(envioSeleccionado);
      } else {
          mostrarModal('Error', 'No se encontraron los datos del envío para iniciar la preparación.');
      }
      // Reactivamos el botón por si el usuario cancela y vuelve
      targetButton.disabled = false;

  } else if (accion === 'guardar-cambios') {
    targetButton.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
    const datos = {
      idEnvio: idEnvio,
      nuevoEstado: document.querySelector(`.estado-select[data-id="${idEnvio}"]`).value,
      nuevaFechaColecta: document.querySelector(`.input-fecha-colecta-card[data-id="${idEnvio}"]`).value,
      idMeli: document.querySelector(`.input-id-ml[data-id="${idEnvio}"]`).value,
      notas: document.querySelector(`.input-notas[data-id="${idEnvio}"]`).value,
    };
    google.script.run
      .withSuccessHandler(msg => {
        mostrarModal('Éxito', msg, [], 'info', 2000);
        cargarVistaDeEnvios();
      })
      .withFailureHandler(err => {
        showError(err);
        targetButton.disabled = false;
        targetButton.innerHTML = originalHtml;
      })
      .actualizarDatosEnvio(datos);

  } else if (accion === 'editar-productos') {
    abrirModalEdicion(idEnvio);
    targetButton.disabled = false;

  } else if (accion === 'eliminar-envio') {
    targetButton.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
    mostrarModal('Confirmar Eliminación', `¿Estás seguro de que quieres eliminar el envío ${idEnvio}?`,
      [
        { texto: 'Cancelar', callback: () => {
            targetButton.disabled = false;
            targetButton.innerHTML = originalHtml;
        }},
        { texto: 'Sí, Eliminar', clase: 'btn btn-confirm', tipo: 'alert', callback: () => {
            google.script.run
              .withSuccessHandler(msg => {
                mostrarModal('Éxito', msg, [], 'info', 2000);
                cargarVistaDeEnvios();
              })
              .withFailureHandler(err => {
                showError(err);
                targetButton.disabled = false;
                targetButton.innerHTML = originalHtml;
              })
              .eliminarEnvio(idEnvio);
        }}
      ],
      'alert'
    );
  }
}


/**
 * Abre el modal de edición de envíos, carga los datos y asigna los listeners,
 * incluyendo el spinner para el botón de guardar.
 */
function abrirModalEdicion(idEnvio) {
  // *** CORRECCIÓN: Reseteamos el estado del botón al abrir el modal ***
  const btnGuardar = document.getElementById('btn-guardar-cambios-envio');
  btnGuardar.disabled = false;
  btnGuardar.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';

  const envio = cacheEnvios.find(e => e.id === idEnvio);
  if (!envio) { mostrarModal('Error', 'No se encontraron los datos del envío.'); return; }
  
  document.getElementById('modal-titulo-envio').textContent = `Editando Productos del Envío: ${idEnvio}`;
  const tablaProductosDiv = document.getElementById('modal-tabla-productos');
  const datalist = document.getElementById('lista-productos');
  
  datalist.innerHTML = '';
  tablaProductosDiv.innerHTML = '<div class="loading"><span>Cargando...</span></div>';
  document.getElementById('modal-edicion-envio').style.display = 'flex';

  google.script.run
    .withSuccessHandler(todosLosProductos => {
      const skusEnEnvio = new Set(envio.productos.map(p => p.sku));
      const productosDisponibles = todosLosProductos.filter(p => !skusEnEnvio.has(p.sku));
      
      let datalistHtml = '';
      productosDisponibles.forEach(p => { datalistHtml += `<option value="${p.sku}">${p.titulo}</option>`; });
      datalist.innerHTML = datalistHtml;
      
      let tablaHtml = '<table id="tabla-edicion-productos" style="width:100%; border-collapse: collapse;"><thead><tr><th style="text-align:left;">SKU / Título</th><th style="text-align:right;">Cantidad</th><th></th></tr></thead><tbody>';
      envio.productos.forEach(p => {
        tablaHtml += `<tr data-sku="${p.sku}" data-titulo="${p.titulo}">
          <td><strong>${p.sku}</strong><br><small style="color: var(--text-light);">${p.titulo}</small></td>
          <td><input type="number" value="${p.cantidad}" min="1" class="input-cantidad-edicion" style="width:70px; text-align:right;"></td>
          <td style="text-align:center;"><button class="btn-eliminar-producto" style="background:none; border:none; color:var(--danger-color); cursor:pointer;"><i class="fas fa-times-circle"></i></button></td>
        </tr>`;
      });
      tablaHtml += '</tbody></table>';
      tablaProductosDiv.innerHTML = tablaHtml;
    })
    .withFailureHandler(showError)
    .obtenerTodosLosProductosParaSelector();
  
  document.getElementById('btn-cancelar-edicion').onclick = () => document.getElementById('modal-edicion-envio').style.display = 'none';
  
  tablaProductosDiv.onclick = (e) => {
    if (e.target.closest('.btn-eliminar-producto')) e.target.closest('tr').remove();
  };

  document.getElementById('btn-agregar-producto').onclick = () => {
      const skuInput = document.getElementById('input-nuevo-sku');
      const cantInput = document.getElementById('input-nueva-cantidad');
      const sku = skuInput.value.trim().toUpperCase();
      const cant = cantInput.value;
      if (!sku || !cant || cant < 1) { mostrarModal('Atención', "Ingresa un SKU y cantidad válida."); return; }
      if (tablaProductosDiv.querySelector(`tr[data-sku="${sku}"]`)) { mostrarModal('Atención', "Ese SKU ya está en la lista."); return; }
      
      const option = datalist.querySelector(`option[value="${sku}"]`);
      const titulo = option ? option.innerText : '(Nuevo Producto)';
      
      const nuevaFila = document.createElement('tr');
      nuevaFila.dataset.sku = sku;
      nuevaFila.dataset.titulo = titulo;
      nuevaFila.innerHTML = `
          <td><strong>${sku}</strong><br><small style="color: var(--text-light);">${titulo}</small></td>
          <td><input type="number" value="${cant}" min="1" class="input-cantidad-edicion" style="width:70px; text-align:right;"></td>
          <td style="text-align:center;"><button class="btn-eliminar-producto"><i class="fas fa-times-circle"></i></button></td>`;
      tablaProductosDiv.querySelector('tbody').appendChild(nuevaFila);
      skuInput.value = '';
      cantInput.value = '';
  };

  document.getElementById('btn-guardar-cambios-envio').onclick = () => {
      const nuevosProductos = [];
      document.querySelectorAll('#tabla-edicion-productos tbody tr').forEach(fila => {
          nuevosProductos.push({
              sku: fila.dataset.sku,
              titulo: fila.dataset.titulo,
              cantidad: parseInt(fila.querySelector('.input-cantidad-edicion').value)
          });
      });
      
      btnGuardar.disabled = true;
      btnGuardar.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Guardando...';
      
      setTimeout(() => {
        google.script.run
            .withSuccessHandler(msg => {
                mostrarModal('Éxito', msg, [], 'info', 2000);
                document.getElementById('modal-edicion-envio').style.display = 'none';
                cargarVistaDeEnvios();
            })
            .withFailureHandler(err => {
                showError(err);
                btnGuardar.disabled = false;
                btnGuardar.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
            })
            .modificarEnvio(idEnvio, nuevosProductos);
      }, 10);
  };
}





//====================================================================================================
// --- LOGICA CALCULO DE ENVIOS ---
//===================================================================================================================

function handleCalcularClick() {
    const modal = document.getElementById('modal-fecha-colecta');
    modal.style.display = 'flex';
    const manana = new Date();
    manana.setDate(manana.getDate() + 1);
    document.getElementById('input-fecha-colecta').valueAsDate = manana;
    document.getElementById('btn-cancelar-colecta').onclick = () => modal.style.display = 'none';
    document.getElementById('btn-confirmar-colecta').onclick = () => {
      const fechaColecta = document.getElementById('input-fecha-colecta').value;
      if (!fechaColecta) { mostrarModal('Atención', 'Debes seleccionar una fecha.'); return; }
      window.fechaColectaCalculada = fechaColecta;
      modal.style.display = 'none';
      const btn = document.getElementById('btn-calcular-envios');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i><span>Calculando...</span>';
      document.getElementById('sugerencias-tabla-div').innerHTML = '<div class="loading"><span>Procesando...</span></div>';
      const parametros = { tt: parseFloat(document.getElementById('tiempoTransito').value) || 0, fe: parseFloat(document.getElementById('frecuenciaEnvio').value) || 0, z: parseFloat(document.getElementById('nivelServicio').value) || 0, fechaColecta: fechaColecta };
      google.script.run.withSuccessHandler(() => {
          google.script.run.withSuccessHandler(data => {
              drawSugerenciasTable(data);
              btn.disabled = false;
              btn.innerHTML = '<i class="fas fa-calculator"></i><span>Calcular Sugerencias</span>';
          }).withFailureHandler(showError).obtenerSugerenciasParaWebapp();
      }).withFailureHandler(showError).actualizarYCalcularSugerencias(parametros);
    };
  }




// ▼▼▼ REEMPLAZA esta función completa ▼▼▼
function drawSugerenciasTable(dataFromServer) {
  const tablaDiv = document.getElementById('sugerencias-tabla-div');
  if (!dataFromServer || dataFromServer.length <= 1) {
    tablaDiv.innerHTML = '<div class="loading"><span>No se generaron sugerencias.</span></div>';
    return;
  }
  const headers = dataFromServer.shift();
  headers[7] = "A ENVIAR (Editable)";
  headers.unshift('Sel.');

  const dataWithInputs = dataFromServer.map(row => {
    const newRow = [...row];
    const sku = newRow[0];
    const cantidad = newRow[7];
    const checkboxHtml = `<input type="checkbox" class="fila-seleccionada" data-sku="${sku}">`;
    const cantidadHtml = `<input type="number" class="cantidad-a-enviar" value="${cantidad}" min="0" style="width: 70px; text-align: right;">`;
    newRow[7] = cantidadHtml;
    newRow.unshift(checkboxHtml);
    return newRow;
  });
  
  const finalData = [headers, ...dataWithInputs];
  const data = google.visualization.arrayToDataTable(finalData);
  const table = new google.visualization.Table(tablaDiv);
  table.draw(data, { allowHtml: true, width: '100%', height: '100%', sort: 'disable', cssClassNames: { headerRow: 'google-visualization-table-th', tableCell: 'google-visualization-table-td' } });
  
  document.getElementById('registro-container').style.display = 'flex'; // Cambiado a flex para que se vea bien
  document.getElementById('filtro-container').style.display = 'flex';
  setupSugerenciasTableListeners();

  // *** LÍNEA CLAVE AÑADIDA ***
  // Simulamos un clic en el botón "Todos" para establecer el estado inicial del filtro.
  document.querySelector('#filtro-container .btn-filtro[data-filtro="todos"]').click();
}




function handleRegistrarEnvioClick() {
  const checkboxes = document.querySelectorAll('.fila-seleccionada:checked');
  if (checkboxes.length === 0) { mostrarModal('Atención', 'Selecciona al menos un producto.'); return; }
  
  const modal = document.getElementById('modal-fecha-colecta');
  modal.style.display = 'flex';
  document.getElementById('input-fecha-colecta').value = window.fechaColectaCalculada || new Date().toISOString().split('T')[0];

  document.getElementById('btn-cancelar-colecta').onclick = () => modal.style.display = 'none';
  document.getElementById('btn-confirmar-colecta').onclick = () => {
    const fechaColecta = document.getElementById('input-fecha-colecta').value;
    if (!fechaColecta) { mostrarModal('Atención', 'Debes seleccionar una fecha.'); return; }
    modal.style.display = 'none';
    
    const productosParaEnviar = [];
    checkboxes.forEach(cb => {
      const fila = cb.closest('tr');
      // *** CORRECCIÓN: Obtenemos el título de la tabla ***
      const titulo = fila.cells[2].textContent;
      const inputCantidad = fila.querySelector('.cantidad-a-enviar');
      const cantidad = parseInt(inputCantidad.value);
      if (cantidad > 0) {
        productosParaEnviar.push({
          sku: cb.dataset.sku,
          titulo: titulo,
          cantidad: cantidad
        });
      }
    });

    if (productosParaEnviar.length === 0) { mostrarModal('Atención', 'No hay productos con cantidad > 0.'); return; }
    
    const btnRegistro = document.getElementById('btn-registrar-envio');
    btnRegistro.disabled = true; btnRegistro.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i><span>Registrando...</span>';
    
    google.script.run
      .withSuccessHandler(mensaje => {
        mostrarModal('Éxito', mensaje, [], 'info', 2500);
        btnRegistro.disabled = false; btnRegistro.innerHTML = '<i class="fas fa-save"></i><span>Registrar Envío</span>';
        document.getElementById('sugerencias-tabla-div').innerHTML = '<div class="loading"><span>Presiona "Calcular" para nuevas sugerencias.</span></div>';
        document.getElementById('registro-container').style.display = 'none';
        document.getElementById('filtro-container').style.display = 'none';
      }).withFailureHandler(showError).registrarEnvio(productosParaEnviar, fechaColecta);
  };
}



function handleDescargarBorradorClick() {
    const btn = document.getElementById('btn-descargar-borrador');
    const checkboxes = document.querySelectorAll('.fila-seleccionada:checked');
    if (checkboxes.length === 0) {
      mostrarModal('Atención', 'Por favor, selecciona al menos un producto para incluir en el borrador del PDF.');
      return;
    }
    
    const productosParaPdf = [];
    checkboxes.forEach(cb => {
      const fila = cb.closest('tr');
      const sku = fila.cells[1].textContent;
      const titulo = fila.cells[2].textContent;
      const cantidad = fila.querySelector('.cantidad-a-enviar').value;
      if (parseInt(cantidad) > 0) {
        productosParaPdf.push({ sku: sku, titulo: titulo, cantidad: cantidad });
      }
    });

    if (productosParaPdf.length === 0) {
      mostrarModal('Atención', 'No hay productos seleccionados con cantidad mayor a cero.');
      return;
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i><span>Generando...</span>';

    google.script.run
      .withSuccessHandler(resultado => {
        descargarArchivoBase64(resultado.data, resultado.filename);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-file-pdf"></i> Descargar Borrador';
      })
      .withFailureHandler(showError)
      .generarPdfBorrador(productosParaPdf);
  }


// =====================================================================================================================================
// --- FUNCIONES AUXILIARES ---
//===================================================================================================================


function showError(error) {
  // Ahora usamos nuestro modal personalizado para los errores
  mostrarModal('Ocurrió un Error', error.message, [{texto: 'Cerrar'}], 'alert');
  // Reactivamos los botones principales si existen
  const btnCalcular = document.getElementById('btn-calcular-envios');
  if(btnCalcular) { btnCalcular.disabled = false; btnCalcular.innerHTML = '<i class="fas fa-calculator"></i><span>Calcular Sugerencias de Envío</span>'; }
  const btnRegistro = document.getElementById('btn-registrar-envio');
  if(btnRegistro) { btnRegistro.disabled = false; btnRegistro.innerHTML = '<i class="fas fa-save"></i><span>Registrar Envío Seleccionado</span>'; }
}



  function setLoadingState(isLoading) {
    // Esta función puede mejorarse para mostrar spinners en cada tarjeta
    document.getElementById('seccion-dashboard').style.opacity = isLoading ? 0.5 : 1;
  }
  
  function setTrendIndicator(elementId, actual, anterior) {
    const el = document.getElementById(elementId);
    if (!el) return;
    let icon = '<i class="fas fa-minus"></i>';
    let className = 'card-trend';
    let texto = 'vs. período anterior';

    if (anterior > 0) {
      const cambio = ((actual - anterior) / anterior) * 100;
      if (cambio > 0.1) {
        icon = '<i class="fas fa-arrow-up"></i>';
        className += ' trend-up';
        texto = `+${cambio.toFixed(1)}%`;
      } else if (cambio < -0.1) {
        icon = '<i class="fas fa-arrow-down"></i>';
        className += ' trend-down';
        texto = `${cambio.toFixed(1)}%`;
      } else {
        texto = `~0.0%`;
      }
    } else if (actual > 0) {
       texto = 'Nuevo';
    }
    el.className = className;
    el.innerHTML = `${icon} ${texto}`;
  }

  // Helper para convertir google.script.run en una Promesa
  function llamarBackend(nombreFuncion, args) {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        [nombreFuncion](args);
    });
  }
  
  function showError(error) {
    alert("Ocurrió un error: " + error.message);
    setLoadingState(false);
  }



function actualizarFechaUltimoDato() {
  google.script.run
    .withSuccessHandler(estado => {
      const el = document.getElementById('last-update');
      let html = '';
      const options = { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' };
      
      if (estado.ultimaSincronizacionInicio && estado.ultimaSincronizacionInicio.includes('T')) {
        const fechaInicio = new Date(estado.ultimaSincronizacionInicio);
        html += `Últ. Intento: <strong>${fechaInicio.toLocaleDateString('es-AR', options)} hs</strong>`;
      }
      
      if (estado.ultimaSincronizacionExitosa && estado.ultimaSincronizacionExitosa.includes('T')) {
        const fechaExito = new Date(estado.ultimaSincronizacionExitosa);
        html += ` | Últ. Éxito: <strong>${fechaExito.toLocaleDateString('es-AR', options)} hs</strong>`;
      }
      
      if (estado.ultimoDato && estado.ultimoDato.includes('T')) {
        const fechaDato = new Date(estado.ultimoDato);
        html += ` | Último Dato: <strong>${fechaDato.toLocaleDateString('es-AR', {day:'2-digit', month:'2-digit'})}</strong>`;
      }
      el.innerHTML = html || 'No hay datos de actualización.';
    })
    .obtenerEstadoActualizacion();
}


function mostrarModal(titulo, mensaje, botones = [{texto: 'Aceptar'}], tipo = 'info', duracion = 0) {
  const modal = document.getElementById('modal-generico');
  document.getElementById('modal-titulo').textContent = titulo;
  document.getElementById('modal-mensaje').textContent = mensaje;
  const botonesDiv = document.getElementById('modal-botones');
  botonesDiv.innerHTML = '';

  botones.forEach(btnInfo => {
    const btn = document.createElement('button');
    btn.textContent = btnInfo.texto;
    btn.className = btnInfo.clase || 'btn';
    if (btnInfo.tipo === 'confirm') btn.classList.add('btn-confirm');
    btn.onclick = () => {
      modal.style.display = 'none';
      if (btnInfo.callback) btnInfo.callback();
    };
    botonesDiv.appendChild(btn);
  });
  
  modal.className = tipo;
  modal.style.display = 'flex';

  // *** MEJORA: Si se especifica una duración, el modal se cierra solo ***
  if (duracion > 0) {
    setTimeout(() => {
      modal.style.display = 'none';
    }, duracion);
  }
}


function descargarArchivoBase64(base64Data, nombreArchivo) {
    const link = document.createElement('a');
    link.href = 'data:application/pdf;base64,' + base64Data;
    link.download = nombreArchivo;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }


//================================== Seguimiento Stock =========================


// ▼▼▼ REEMPLAZA esta función ▼▼▼
function cargarVistaStock() {
  const tablaDiv = document.getElementById('tabla-stock-div');
  tablaDiv.innerHTML = '<div class="loading"><i class="fas fa-circle-notch fa-spin"></i><span>Cargando stock de todas las publicaciones...</span></div>';
  
  google.script.run
    .withSuccessHandler(data => {
      drawTablaStock(data);
    })
    .withFailureHandler(showError)
    .obtenerResumenDeStock();
}

// ▼▼▼ REEMPLAZA esta función ▼▼▼
function drawTablaStock(data) {
  const tablaDiv = document.getElementById('tabla-stock-div');
  window.datosStock = data; 

  if (!data || data.length === 0) {
    tablaDiv.innerHTML = '<div class="loading">No se encontraron publicaciones.</div>';
    return;
  }
  
  const dataTable = new google.visualization.DataTable();
  dataTable.addColumn('string', 'SKU / Título');
  dataTable.addColumn('string', 'Estado'); // Nueva columna
  dataTable.addColumn('string', 'Tipo Envío');
  dataTable.addColumn('string', 'Stock Depósito');
  dataTable.addColumn('number', 'Stock Full');
  dataTable.addColumn('string', 'Activar Flex');

  const rows = data.map(p => {
    const esFull = p.tipoLogistica === 'fulfillment';
    
    // Switch para el Estado (Activa/Pausada)
    const estadoChecked = p.estado === 'active' ? 'checked' : '';
    const switchEstado = `
      <label class="switch">
        <input type="checkbox" class="estado-toggle" data-item-id="${p.itemId}" ${estadoChecked}>
        <span class="slider"></span>
      </label>`;

    // Input para Stock Depósito (Editable)
    const stockInput = `<input type="number" class="stock-editable" value="${p.stockDeposito}" data-item-id="${p.itemId}">`;

    // Switch para Flex
    const flexDisabled = esFull && !p.tieneFlex; // Deshabilitado solo si es "Full-Only"
    const flexChecked = p.tieneFlex ? 'checked' : '';
    const switchFlex = `
      <label class="switch">
        <input type="checkbox" class="flex-toggle" data-item-id="${p.itemId}" ${flexChecked} ${flexDisabled ? 'disabled' : ''}>
        <span class="slider"></span>
      </label>`;

    // Etiqueta para Tipo de Envío
    let tipoEnvioLabel = '';
    if (esFull) tipoEnvioLabel += 'Full';
    if (p.tieneFlex) tipoEnvioLabel += (tipoEnvioLabel ? ' + Flex' : 'Flex');
    if (p.tipoLogistica === 'drop_off' || p.tipoLogistica === 'cross_docking') tipoEnvioLabel += (tipoEnvioLabel ? ' + Normal' : 'Normal');
    if (tipoEnvioLabel === '') tipoEnvioLabel = p.tipoLogistica;

    return [
      `<strong>${p.sku}</strong><br><small>${p.titulo}</small>`,
      switchEstado,
      tipoEnvioLabel,
      stockInput,
      p.stockFull,
      switchFlex
    ];
  });
  dataTable.addRows(rows);

  const table = new google.visualization.Table(tablaDiv);
  table.draw(dataTable, { allowHtml: true, width: '100%', sort: 'enable', sortColumn: 0, sortAscending: true, cssClassNames: { headerRow: 'google-visualization-table-th', tableCell: 'google-visualization-table-td' } });
}


/**
 * Filtra la tabla de stock basándose en el texto del buscador.
 */
function filtrarTablaStock() {
    if (!window.datosStock) return;
    const textoBusqueda = document.getElementById('input-buscar-stock').value.toLowerCase().trim();
    
    const datosFiltrados = window.datosStock.filter(p => {
        return p.sku.toLowerCase().includes(textoBusqueda) || p.titulo.toLowerCase().includes(textoBusqueda);
    });
    drawTablaStock(datosFiltrados);
}


// ▼▼▼ AÑADE esta nueva función ▼▼▼

/**
 * Recorre la tabla de stock, compara los valores actuales (Stock, Flex y Estado)
 * con los originales y resalta las filas que han cambiado.
 */
function handlePrevisualizarStock() {
  if (!window.datosStock || window.datosStock.length === 0) {
    mostrarModal('Error', 'No hay datos de stock cargados para comparar.');
    return;
  }

  const filasTabla = document.querySelectorAll("#tabla-stock-div tbody tr");
  let cambiosDetectados = 0;

  filasTabla.forEach(fila => {
    // 1. Buscamos los 3 controles en la fila
    const inputStock = fila.querySelector('.stock-editable');
    const checkFlex = fila.querySelector('.flex-toggle');
    const checkEstado = fila.querySelector('.estado-toggle');
    
    if (!inputStock || !checkFlex || !checkEstado) return; 

    const itemId = inputStock.dataset.itemId || checkFlex.dataset.itemId;
    if (!itemId) return;

    // 2. Encontramos el producto original en nuestros datos cacheados
    const productoOriginal = window.datosStock.find(p => p.itemId === itemId);
    if (!productoOriginal) return;

    // 3. Leemos los valores ACTUALES de la interfaz
    const stockActual = parseInt(inputStock.value);
    const flexActual = checkFlex.checked;
    const estadoActual = checkEstado.checked ? 'active' : 'paused'; // Convertimos el check a 'active'/'paused'

    // 4. Comparamos con los valores ORIGINALES
    const stockCambiado = (productoOriginal.stockDeposito !== stockActual);
    const flexCambiado = (productoOriginal.tieneFlex !== flexActual);
    const estadoCambiado = (productoOriginal.estado !== estadoActual); // <-- Comparamos el estado

    // 5. Aplicamos o quitamos el resaltado
    if (stockCambiado || flexCambiado || estadoCambiado) {
      fila.classList.add('fila-modificada');
      cambiosDetectados++;
    } else {
      fila.classList.remove('fila-modificada');
    }
  });

  if (cambiosDetectados > 0) {
    mostrarModal('Previsualización', `Se han detectado ${cambiosDetectados} publicaciones con cambios. Las filas están resaltadas en amarillo.`, [], 'info', 3000);
  } else {
    mostrarModal('Previsualización', 'No se encontraron cambios para guardar.', [], 'info', 2000);
  }
}

/**
 * Recopila todos los cambios de la tabla de stock, pide confirmación
 * y los envía al servidor para ser guardados en Mercado Libre.
 */
function handleGuardarStockClick() {
  const filasTabla = document.querySelectorAll("#tabla-stock-div tbody tr");
  if (!window.datosStock || window.datosStock.length === 0 || filasTabla.length === 0) {
    mostrarModal('Error', 'No hay datos de stock cargados para guardar.');
    return;
  }

  const cambiosParaEnviar = [];
  filasTabla.forEach(fila => {
    const inputStock = fila.querySelector('.stock-editable');
    const checkFlex = fila.querySelector('.flex-toggle');
    if (!inputStock || !checkFlex) return;

    const itemId = inputStock.dataset.itemId || checkFlex.dataset.itemId;
    if (!itemId) return;

    const productoOriginal = window.datosStock.find(p => p.itemId === itemId);
    if (!productoOriginal) return;

    const stockActual = parseInt(inputStock.value);
    const flexActual = checkFlex.checked;

    const stockCambiado = (productoOriginal.stockDeposito !== stockActual);
    const flexCambiado = (productoOriginal.tieneFlex !== flexActual);

    if (stockCambiado || flexCambiado) {
      cambiosParaEnviar.push({
        itemId: itemId,
        sku: productoOriginal.sku,
        stockCambiado: stockCambiado,
        nuevoStock: stockActual,
        flexCambiado: flexCambiado,
        nuevoFlex: flexActual
      });
    }
  });

  if (cambiosParaEnviar.length === 0) {
    mostrarModal('Información', 'No se detectaron cambios para guardar.');
    return;
  }

  // Mostramos el modal de confirmación
  mostrarModal('Confirmar Cambios', `Estás a punto de guardar ${cambiosParaEnviar.length} cambios en Mercado Libre. Esta acción es irreversible. ¿Continuar?`, [
    { texto: 'Cancelar' },
    {
      texto: 'Sí, Guardar Cambios',
      clase: 'btn btn-secondary',
      callback: () => {
        const btn = document.getElementById('btn-guardar-cambios-stock');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Guardando...';

        google.script.run
          .withSuccessHandler(resultado => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
            
            let mensaje = `${resultado.exitosos.length} cambios se guardaron con éxito.`;
            if (resultado.fallidos.length > 0) {
              mensaje += `\n${resultado.fallidos.length} fallaron.`;
            }
            
            mostrarModal('Proceso Finalizado', mensaje, [{
              texto: 'Aceptar y Recargar',
              clase: 'btn',
              callback: () => cargarVistaStock() // Recargamos la vista para tener los datos frescos
            }]);
          })
          .withFailureHandler(err => {
            showError(err);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
          })
          .actualizarStockYFlexEnLote(cambiosParaEnviar);
      }
    }
  ]);
}

//========================== Gestion deposito externo ======================

/**
 * Carga la vista de Gestión de Depósito 3PL.
 * Ahora solo resetea la vista, los listeners se activan al inicio.
 */
function cargarVistaGestion3PL() {
  console.log("Cargando la vista de Gestión 3PL...");
  resetearVista3PL(); // Asegura que la vista esté en su estado inicial
}



/**
 * Dibuja la tabla de reconciliación de stock 3PL.
 * VERSIÓN MEJORADA: Maneja el caso de productos no reportados en el Excel.
 */
function drawTablaReconciliacion(data) {
  const tablaDiv = document.getElementById('tabla-reconciliacion-div');
  if (!data || data.length === 0) {
    tablaDiv.innerHTML = '<div class="loading">No se encontraron productos con stock en ML ni coincidencias en el Excel.</div>';
    return;
  }
  
  const dataTable = new google.visualization.DataTable();
  dataTable.addColumn('string', 'SKU');
  dataTable.addColumn('string', 'Título');
  dataTable.addColumn('number', 'Stock Real (Excel)');
  dataTable.addColumn('number', 'Stock en ML (API)');
  dataTable.addColumn('number', 'Diferencia');
  
  // Añadimos una columna de string "formateada" para el stock de Excel
  // Esto nos permite mostrar "No Reportado" y aun así ordenar numéricamente.
  dataTable.addColumn({'type': 'string', 'role': 'annotation'});

  const filasConDiferencia = [];
  const filasSinDiferencia = [];

  data.forEach(p => {
    const stockExcelMostrado = (p.stockExcel === null) ? 0 : p.stockExcel;
    const stockExcelFormateado = (p.stockExcel === null) ? "No Reportado" : String(p.stockExcel);
    
    // [SKU, Título, StockExcel (para ordenar), StockAPI, Diferencia, StockExcel (para mostrar)]
    const row = [p.sku, p.titulo, stockExcelMostrado, p.stockAPI, p.diferencia, stockExcelFormateado];
    
    if (p.diferencia !== 0) {
      filasConDiferencia.push(row);
    } else {
      filasSinDiferencia.push(row);
    }
  });

  const rows = [...filasConDiferencia, ...filasSinDiferencia];
  dataTable.addRows(rows);

  // Creamos una DataView para ocultar la columna numérica de 'Stock Real' y usar la de texto en su lugar.
  const view = new google.visualization.DataView(dataTable);
  view.setColumns([0, 1, 5, 3, 4]); // Ocultamos la col 2 (numérica), mostramos la 5 (texto)

  // Formatos
  const formatter = new google.visualization.NumberFormat({ pattern: '#,##0' });
  formatter.format(dataTable, 3); // Stock en ML
  formatter.format(dataTable, 4); // Diferencia

  const formatterRojo = new google.visualization.ColorFormat();
  formatterRojo.addRange(-Infinity, 0, '#660000', '#FFCDD2'); // Negativo (Diferencia < 0)
  formatterRojo.addRange(0, Infinity, '#004D40', '#C8E6C9'); // Positivo (Diferencia > 0)
  formatterRojo.format(dataTable, 4); 

  const table = new google.visualization.Table(tablaDiv);
  // Usamos la 'view' para dibujar, en lugar de 'dataTable'
  table.draw(view, { 
    allowHtml: true, 
    width: '100%', 
    sort: 'disable', 
    cssClassNames: { headerRow: 'google-visualization-table-th', tableCell: 'google-visualization-table-td' } 
  });
}



/**
 * Resetea la vista de 3PL a su estado inicial, mostrando la
 * zona de "drop" y ocultando los resultados anteriores.
 */
function resetearVista3PL() {
  document.getElementById('drop-zone').style.display = 'block';
  document.getElementById('panel-resultados-reconciliacion').style.display = 'none';
  document.getElementById('tabla-reconciliacion-div').innerHTML = '';
  document.getElementById('info-reconciliacion').textContent = '';
  document.getElementById('file-input-excel').value = null; // Resetea el input de archivo
}

/**
 * Función centralizada que lee el archivo Excel y llama al servidor.
 * @param {File} file - El archivo cargado por el usuario.
 */
function procesarArchivoExcel(file) {
  if (!file || (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls'))) {
    mostrarModal('Error', 'Por favor, carga un archivo Excel válido (.xlsx o .xls).');
    return;
  }

  // Ocultamos la zona de drop y mostramos el panel de resultados con un spinner
  document.getElementById('drop-zone').style.display = 'none';
  document.getElementById('panel-resultados-reconciliacion').style.display = 'block';
  const tablaDiv = document.getElementById('tabla-reconciliacion-div');
  tablaDiv.innerHTML = '<div class="loading"><i class="fas fa-circle-notch fa-spin"></i><span>Leyendo archivo Excel...</span></div>';
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const firstSheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[firstSheetName];
      const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
      
      if (jsonData.length < 7) { throw new Error('El archivo Excel está vacío o no tiene el formato esperado (datos desde fila 7).'); }
      
      const headers = jsonData[5].map(h => (h ? String(h).toLowerCase().trim() : ""));
      const skuIndex = headers.indexOf('codigo de barras');
      const stockIndex = headers.indexOf('stock');

      if (skuIndex === -1) { throw new Error('No se encontró la columna "CODIGO DE BARRAS" en la fila 6.'); }
      if (stockIndex === -1) { throw new Error('No se encontró la columna "STOCK" en la fila 6.'); }

      const datosDelExcel = jsonData.slice(6);
      const stock3PL = {};
      datosDelExcel.forEach(row => {
        if (row.length > skuIndex && row.length > stockIndex) {
          const sku = row[skuIndex];
          const stock = parseInt(row[stockIndex], 10);
          if (sku && !isNaN(stock)) {
            stock3PL[String(sku).trim().toUpperCase()] = stock;
          }
        }
      });
      
      const numSkusLeidos = Object.keys(stock3PL).length;
      if (numSkusLeidos === 0) { throw new Error("No se encontraron SKUs válidos en el archivo."); }
      
      document.getElementById('info-reconciliacion').textContent = `Archivo "${file.name}" cargado. ${numSkusLeidos} SKUs encontrados. Cruzando con Mercado Libre...`;
      tablaDiv.innerHTML = '<div class="loading"><i class="fas fa-circle-notch fa-spin"></i><span>Consultando stock en Mercado Libre...</span></div>';

      // LLAMADA AL SERVIDOR
      google.script.run
        .withSuccessHandler(datosReconciliados => {
          window.datosReconciliacion = datosReconciliados; 
          drawTablaReconciliacion(datosReconciliados);
          document.getElementById('info-reconciliacion').textContent = `Comparación finalizada. ${datosReconciliados.length} productos coincidentes encontrados.`;
        })
        .withFailureHandler(showError)
        .reconciliarStockConAPI(stock3PL);

    } catch (err) {
      showError(new Error(`Error al procesar el archivo Excel: ${err.message}`));
      resetearVista3PL(); // Si falla, reseteamos la vista
    }
  };
  reader.onerror = (err) => { showError(new Error("Error al leer el archivo.")); };
  reader.readAsArrayBuffer(file);
}



/**
 * Se activa al hacer clic en "Ajustar Stock en ML".
 * Filtra solo los productos con diferencias y los envía al servidor.
 */
function handleAjustarStockClick() {
  if (!window.datosReconciliacion || window.datosReconciliacion.length === 0) {
    mostrarModal('Error', 'No hay datos de reconciliación cargados.');
    return;
  }

  // Filtramos solo los productos que tienen una diferencia
  const productosParaAjustar = window.datosReconciliacion
    .filter(p => p.diferencia !== 0 && p.stockExcel !== null)
    .map(p => ({
      itemId: p.itemId,
      sku: p.sku,
      userProductId: p.userProductId,
      nuevoStock: p.stockExcel // El stock del Excel es la "verdad"
    }));

  if (productosParaAjustar.length === 0) {
    mostrarModal('Información', 'No se encontraron diferencias para ajustar.', [], 'info', 2000);
    return;
  }

  // Pedimos confirmación
  mostrarModal('Confirmar Ajuste de Stock', 
    `Estás a punto de actualizar el stock en Mercado Libre para ${productosParaAjustar.length} productos para que coincida con tu archivo de Excel. Esta acción no se puede deshacer. ¿Continuar?`, 
    [
      { texto: 'Cancelar' },
      {
        texto: 'Sí, Ajustar Stock',
        clase: 'btn btn-danger', // Usamos la clase de Bootstrap para peligro
        callback: () => {
          const btn = document.getElementById('btn-ajustar-stock-ml');
          btn.disabled = true;
          btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Ajustando...';

          google.script.run
            .withSuccessHandler(resultado => {
              btn.disabled = false;
              btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Ajustar Stock en ML';
              
              let mensaje = `${resultado.exitosos.length} productos ajustados con éxito.`;
              if (resultado.fallidos.length > 0) {
                mensaje += `\n${resultado.fallidos.length} fallaron. Revisa los logs.`;
              }
              
              mostrarModal('Proceso Finalizado', mensaje, [{
                texto: 'Aceptar y Recargar',
                clase: 'btn',
                callback: () => {
                  // Reseteamos la vista para forzar una nueva carga de archivo
                  resetearVista3PL();
                }
              }]);
            })
            .withFailureHandler(err => {
              showError(err);
              btn.disabled = false;
              btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Ajustar Stock en ML';
            })
            .ajustarStockDesdeExcel(productosParaAjustar);
        }
      }
    ],
    'alert' // Usamos el estilo de alerta
  );
}


// Preparacion envios 



/**
 * Configura los "oídos" del escáner y los botones para esta sección.
 */
function setupScanner3PL() {
  const input = document.getElementById('input-escaner-3pl');
  const btnSumar = document.getElementById('btn-sumar-3pl');
  const btnRestar = document.getElementById('btn-restar-3pl');

  // Listener para el escáner (cuando presiona Enter)
  input.onkeydown = (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      procesarCodigo3PL(input.value.trim().toUpperCase());
    }
  };

  // Listeners para los botones manuales
  btnSumar.onclick = () => modificarCantidadFoco3PL(1);
  btnRestar.onclick = () => modificarCantidadFoco3PL(-1);
}




function iniciarPreparacion3PL() {
  const btn = document.getElementById('btn-iniciar-preparacion-3pl');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Verificando...';

  // 1. Primero, preguntamos si hay un borrador guardado
  google.script.run
    .withSuccessHandler(borrador => {
      if (borrador && borrador.length > 0) {
        // 2A. ¡Hay un borrador! Preguntamos al usuario qué hacer.
        mostrarModal('Envío Pendiente Encontrado', `Tienes un envío guardado con ${borrador.length} productos. ¿Qué deseas hacer?`, [
          { 
            texto: 'Descartar y Empezar Nuevo', 
            clase: 'btn btn-danger',
            callback: () => cargarCatalogoYEmpezar([]) // Empezamos con lista vacía
          },
          { 
            texto: 'Retomar Envío Guardado', 
            clase: 'btn btn-confirm', 
            callback: () => cargarCatalogoYEmpezar(borrador) // Empezamos con el borrador
          }
        ]);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-barcode"></i> Iniciar Escaneo de Envío';

      } else {
        // 2B. No hay borrador, empezamos directo.
        cargarCatalogoYEmpezar([]);
      }
    })
    .withFailureHandler(showError)
    .cargarBorrador3PL();
}


// --- Función auxiliar para cargar el catálogo y mostrar la pantalla ---
function cargarCatalogoYEmpezar(productosIniciales) {
  const btn = document.getElementById('btn-iniciar-preparacion-3pl');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Cargando catálogo...';

  google.script.run
    .withSuccessHandler(productos => {
      mapaMaestro3PL = {};
      productos.forEach(p => {
        if (p.sku) mapaMaestro3PL[p.sku.trim().toUpperCase()] = p;
        if (p.inventory_id) mapaMaestro3PL[p.inventory_id.trim().toUpperCase()] = p;
      });

      escaneo3PLActivo = true;
      productos3PL = productosIniciales; // Usamos el borrador o empezamos de cero

      document.querySelector('#seccion-gestion-3pl .panel:first-child').style.display = 'none';
      document.getElementById('panel-inicio-3pl').style.display = 'none';
      document.getElementById('panel-preparacion-3pl').style.display = 'block';
      
      actualizarTabla3PL();
      resetearFoco3PL();
      setupScanner3PL(); 

      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-barcode"></i> Iniciar Escaneo de Envío';
    })
    .withFailureHandler(showError)
    .obtenerTodosLosProductosParaSelector();
}


/**
 * Actualiza el panel superior grande con la info del producto recién escaneado.
 */
function enfocarProducto3PL(sku, titulo, codigoEscaneado) {
  document.getElementById('foco-3pl-titulo').textContent = titulo;
  document.getElementById('foco-3pl-titulo').style.color = 'var(--text-color)';
  // Mostramos qué código se escaneó exactamente
  document.getElementById('foco-3pl-sku').innerHTML = `SKU: <strong>${sku}</strong> | Leído: ${codigoEscaneado}`;
  
  document.getElementById('btn-sumar-3pl').disabled = false;
  document.getElementById('btn-restar-3pl').disabled = false;
}



function mostrarErrorFoco3PL(mensaje, codigo) {
  document.getElementById('foco-3pl-titulo').textContent = mensaje;
  document.getElementById('foco-3pl-titulo').style.color = 'var(--danger-color)';
  document.getElementById('foco-3pl-sku').textContent = `Código desconocido: ${codigo}`;
  // Sonido de error opcional
  try { new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play(); } catch(e){}
  document.getElementById('input-escaner-3pl').select(); // Seleccionar para sobreescribir rápido
}



/**
 * Modifica la cantidad (+1 o -1) del producto que está en foco actualmente.
 */
function modificarCantidadFoco3PL(delta) {
  if (!ultimoSkuFoco3PL) return;

  const itemEnCaja = productos3PL.find(p => p.sku === ultimoSkuFoco3PL);
  if (itemEnCaja) {
    itemEnCaja.cantidad += delta;
    
    // Si la cantidad llega a 0, lo sacamos de la caja
    if (itemEnCaja.cantidad <= 0) {
      productos3PL = productos3PL.filter(p => p.sku !== ultimoSkuFoco3PL);
      resetearFoco3PL(); // Ya no hay nada en foco
    } else {
      // Si sigue en la caja, actualizamos el foco con la nueva cantidad
      enfocarProducto3PL(itemEnCaja.sku, itemEnCaja.titulo, itemEnCaja.inventory_id || itemEnCaja.sku);
    }
    actualizarTabla3PL();
  }
}



/**
 * Dibuja la tabla y actualiza los contadores totales.
 */
function actualizarTabla3PL() {
  const tbody = document.getElementById('tbody-productos-3pl');
  tbody.innerHTML = '';
  let totalUds = 0;

  // Dibujamos en orden inverso para que lo último escaneado aparezca arriba
  [...productos3PL].reverse().forEach(p => {
    totalUds += p.cantidad;
    const row = document.createElement('tr');
    // Resaltamos la fila si es la que está en foco
    if (p.sku === ultimoSkuFoco3PL) row.style.backgroundColor = '#e3f2fd'; 
    
    row.innerHTML = `
      <td style="padding: 12px; border-bottom: 1px solid var(--border-color);">
        <strong>${p.sku}</strong><br>
        <small style="color: var(--text-light);">${p.titulo}</small><br>
        <small style="color: var(--primary-color); font-family: monospace;">${p.inventory_id || ''}</small>
      </td>
      <td style="padding: 12px; border-bottom: 1px solid var(--border-color); text-align: center; font-size: 20px; font-weight: bold;">
        ${p.cantidad}
      </td>
      <td style="padding: 12px; border-bottom: 1px solid var(--border-color); text-align: right;">
        <button class="btn-eliminar-fila-3pl" data-sku="${p.sku}" style="color: var(--danger-color); background: none; border: none; cursor: pointer;">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    `;
    tbody.appendChild(row);
  });

  document.getElementById('total-unidades-3pl').textContent = totalUds;
  document.getElementById('total-skus-3pl').textContent = productos3PL.length;
  document.getElementById('btn-finalizar-3pl').disabled = (productos3PL.length === 0);

  // Conectamos los botones de eliminar fila
  document.querySelectorAll('.btn-eliminar-fila-3pl').forEach(btn => {
    btn.onclick = (e) => {
      const skuBorrar = e.currentTarget.dataset.sku;
      productos3PL = productos3PL.filter(p => p.sku !== skuBorrar);
      if (skuBorrar === ultimoSkuFoco3PL) resetearFoco3PL();
      actualizarTabla3PL();
    };
  });
}



/**
 * El cerebro del escaneo: toma un código, lo busca y lo agrega/suma.
 */
function procesarCodigo3PL(codigo) {
  if (!codigo) return;
  
  // 1. Buscamos el producto en nuestro mapa maestro
  const productoInfo = mapaMaestro3PL[codigo];
  
  if (!productoInfo) {
    mostrarErrorFoco3PL("Producto no encontrado", codigo);
    return;
  }

  // 2. Identificamos el producto por su SKU único
  const sku = productoInfo.sku;

  // 3. Vemos si ya estaba en nuestra caja
  const itemEnCaja = productos3PL.find(p => p.sku === sku);
  if (itemEnCaja) {
    itemEnCaja.cantidad++;
  } else {
    // Si es nuevo, lo agregamos a la lista
    productos3PL.push({
      sku: sku,
      titulo: productoInfo.titulo,
      cantidad: 1,
      // Guardamos también el inventory_id si lo tenemos, para mostrarlo
      inventory_id: (codigo !== sku) ? codigo : (productoInfo.itemId || '') 
    });
  }

  // 4. Actualizamos toda la interfaz
  ultimoSkuFoco3PL = sku; // Marcamos quién tiene el "foco" ahora
  actualizarTabla3PL();
  enfocarProducto3PL(sku, productoInfo.titulo, codigo);
  
  // 5. Limpiamos el input para el siguiente escaneo
  document.getElementById('input-escaner-3pl').value = '';
  document.getElementById('input-escaner-3pl').focus();
}



/**
 * Cancela la sesión actual y vuelve al menú principal de 3PL.
 */
function cancelarPreparacion3PL() {
  if (productos3PL.length > 0) {
    // Si ya escaneó algo, pedimos confirmación para no perder trabajo accidentalmente
    mostrarModal('Confirmar Cancelación', 'Tienes productos escaneados. Si sales ahora, se perderá el progreso actual. ¿Seguro que quieres salir?', [
      { texto: 'No, seguir escaneando', callback: () => {} },
      { texto: 'Sí, salir y perder progreso', clase: 'btn btn-danger', callback: ejecutarCancelacion3PL }
    ]);
  } else {
    ejecutarCancelacion3PL();
  }
}


function ejecutarCancelacion3PL() {
  escaneo3PLActivo = false;
  productos3PL = [];
  document.getElementById('panel-preparacion-3pl').style.display = 'none';
  document.querySelector('#seccion-gestion-3pl .panel:first-child').style.display = 'block';
  document.getElementById('panel-inicio-3pl').style.display = 'block';
}


function resetearFoco3PL() {
  ultimoSkuFoco3PL = null;
  document.getElementById('foco-3pl-titulo').textContent = 'Listo para escanear';
  document.getElementById('foco-3pl-titulo').style.color = 'var(--text-color)';
  document.getElementById('foco-3pl-sku').textContent = 'Escanea un producto para agregarlo';
  document.getElementById('btn-sumar-3pl').disabled = true;
  document.getElementById('btn-restar-3pl').disabled = true;
  document.getElementById('input-escaner-3pl').value = '';
  document.getElementById('input-escaner-3pl').focus();
}


// --- AÑADE LA NUEVA FUNCIÓN HANDLER ---
function handleRegistrarEnvio3PL() {
  const transporte = document.getElementById('input-3pl-transporte').value.trim();
  const bultos = document.getElementById('input-3pl-bultos').value;
  const valor = document.getElementById('input-3pl-valor').value;
  const notas = document.getElementById('input-3pl-notas').value.trim();

  if (!transporte) { mostrarModal('Error', 'Por favor, ingresa la Empresa de Transporte.'); return; }
  if (!bultos || parseInt(bultos) < 1) { mostrarModal('Error', 'Ingresa una cantidad válida de bultos.'); return; }

  const datosEnvio = {
    transporte: transporte,
    bultos: bultos,
    valorDeclarado: valor,
    notas: notas
  };

  const btn = document.getElementById('btn-confirmar-finalizar-3pl');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Registrando...';

  google.script.run
    .withSuccessHandler(resultado => {
      document.getElementById('modal-finalizar-3pl').style.display = 'none';
      mostrarModal('¡Envío Registrado!', `${resultado.message}\n(La generación de PDF se implementará próximamente)`, [], 'success', 3000);
      
      // Limpiamos y salimos de la pantalla de preparación
      ejecutarCancelacion3PL(); 
      
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-save"></i> Registrar Envío';
    })
    .withFailureHandler(err => {
      showError(err);
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-save"></i> Registrar Envío';
    })
    .registrarEnvio3PL(datosEnvio, productos3PL); // Enviamos los datos y la lista de productos escaneados
}



</script>
</body>
</html>


